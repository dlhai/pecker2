<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>消息</title>
    <script src="js/jquery.js"></script>
    <script src="js/bootstrap.js"></script>
    <link rel="stylesheet" href="css/bootstrap.css" />
    <script charset="utf-8" src="kindedit/kindeditor-all.js"></script>
    <script charset="utf-8" src="kindedit/lang/zh-CN.js"></script>
    <script src="js/utils.js"></script>
    <script src="js/db.js"></script>
    <link rel="stylesheet" href="css/xpecker.css" />
    <script src="js/xpecker.js"></script>
    <link rel="stylesheet" href="css/cube.css" />
    <script src="js/Cube.js"></script>
    <script src="js/blog.js"></script>
	<style>
		.table {display: table; width: 100%; border-collapse: collapse;}
		.table>div {display: table-row; }
		.table>div>div {display: table-cell; border: 1px solid gray; text-align: center;vertical-align: middle;}

		.list{display: table; width: 100%; border-collapse: collapse;}
		.list>div{display:table-row}
		.list>div>div{display:table-cell;vertical-align: top;border-bottom:1px solid Silver;padding:3px;}
		.list>div>div:first-child{width:48px;}
		.list>div>div>img{border-radius: 4px;}

		.group>div{
            padding: 0px 10px;
            line-height: 20px;
            color: #777777;
            position: relative;
            display: inline-block;
			margin:0 1px;
		}
        .group>.active, .group>div:hover, .group>div:focus, .list>div:hover {
            color: #555555;
            background-color: #d5d5d5;
        }

	</style>
</head>
<body class="xFCsrow">
    <section class="xPanel2 xFIfixed" style="width:350px;">
        <header class="group" onclick="onchggroup(this)"><div class="active">我的偶像</div><div>我的粉丝</div><div>系统消息</div><div>陌生人</div></header>
		<div id="friends">
			<div id="idols" class="list">
				{% for x in idols %}
				<div onclick="onuser(this,{{x.id}})"><div><img width="42px" height="42px" src="{{x.face}}"/></div>
					<div>
						<div>{{x.name}}</div>
						<div>{{x.profile}}</div>
					</div>
				</div>
				{% endfor %}
			</div>
			<div id="fans" class="list" style="display:none">
				{% for x in fans %}
				<div onclick="onuser(this,{{x.id}})"><div><img width="42px" height="42px" src="{{x.face}}"/></div>
					<div>
						<div>{{x.name}}</div>
						<div>{{x.profile}}</div>
					</div>
				</div>
				{% endfor %}
			</div>
			<div id="sysmsgs" class="list" style="display:none">
			</div>
		</div>
    </section>
    <section class="xPanel2">
        <header id="title">对话</header>
        <div id="speechlist" class="xScroll" style="height:100px;flex-grow: 1;"></div>
        <footer class="xFCsrow xFIfixed" style="padding:10px; height: 200px; width: 100%; align-items: flex-end;">
            <textarea id="kereplay" class="xrAngle" style="margin-right:10px; padding:5px 10px; height:180px;width:100px;resize:none;"></textarea>
            <div class="xFIfixed"><button onclick="onsend()">发送</button></div>
        </footer>
	</section>
<script type="text/javascript">
    var g_user = parent.g_user, g_user_id;
    if (g_user == undefined) {Reqdata("/curuserinf", "", function (res) {g_user = res.data;g_user.fields = res.fields;});}

    var kereplay;
    KindEditor.ready(function (K) {
        kereplay = K.create('#kereplay', {
            uploadJson: '/cr', resizeMode:0,items: ['cut', 'copy', 'paste', '|', 'formatblock', 'fontname', 'fontsize', 'forecolor', 'hilitecolor', 'bold', 'italic',
                'underline', 'removeformat', '|', 'link', 'unlink', '|', 'fullscreen',]
        });
    });


    function onchggroup(This) {
		var node = $(event.target);
		$(This).children().removeClass("active");
		node.addClass("active");
		if (node.html() == "我的偶像" ){
			$("#friends").children().hide();
			$("#idols").show();
		}
		else if (node.html() == "我的粉丝" ){
			$("#friends").children().hide();
			$("#fans").show();
		}
		else if (node.html() == "系统消息" ){
			$("#friends").children().hide();
			$("#sysmsgs").show();
		}
    }
    function onuser(This, id) {
        g_user_id = id;
        $("#title").html( "与 <b>"+$(This).find("div > div:first-child").html() +"</b> 会话");
		Reqdata( "/rdmsg?user_id="+id,"", function(res){
            res.data.map(x => x.prof = GetSub(db_job, "id", x.job).sname);
            $("#speechlist").html(res.data.map(x => renderspeech(x).join("")));
		});
    }

    function onsend() {
        kereplay.sync();//将KindEditor的数据同步到textarea标签。
        var value_content = $("#kereplay").val();

        var fd = new FormData();
        fd.append("body", value_content);
        SendForm('/msgto?type=2&user_id=' + g_user_id, fd, "", function (res) {});
    }

    function renderspeech(speech) {
        if (speech.src != g_user.id) {
            r = `<div class="lspeech"><div><img src="{face}" /></div>
                <div><span>【{prof}】{name}</span><div>{say}</div>
                </div></div>`.format(speech)
        }
        else {
            r =`<div class="rspeech"><div><span>【{prof}】{name}</span>
                    <div>{say}</div></div><div><img src="{face}" /></div>
            </div>`.format(speech)
        }
        return r;
    }
</script>

</body>
</html>