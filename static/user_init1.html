<!DOCTYPE html>
<html>
<head>
    <!--user2与user3的区别：将inplace编辑模式改成弹出6编辑窗口式-->
    <meta charset="utf-8">
    <title>啄木鸟风电维保系统</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <link rel="stylesheet" href="css/bootstrap.css"/>
    <script type="text/javascript" src="js/doTe.js"></script>
    <script src="js/jquery.js"></script>
    <script src="js/bootstrap.js"></script>
    <script src="laydate/laydate.js"></script>

    <script src="js/utils.js"></script>
    <link rel="stylesheet" href="css/cube.css" />
    <script src="js/Cube.js"></script>
    <script src="js/db.js"></script>
    <link rel="stylesheet" href="css/xpecker.css" />
    <script src="js/xpecker.js"></script>

    <style>
        .narrow>div>div:first-of-type {width: 140px;}
        .narrow>div>label:first-of-type {width: 40px;}
        .narrow>div,.narrow>div>div:first-of-type {margin-right: 0px;}

        /*为了解决BootStrap中css和layDate的css样式冲突*/
        .laydate_box, .laydate_box * {box-sizing: content-box;}
        .laydate_box th {text-align: center;}
    </style>
</head>
<body>
    <div style="width:900px;height:600px;margin:100px;">
        <header style="height:40px;">总步骤</header>
        <form id="main" style="height:350px;"></form>
        <footer><div style="float:right"><button onclick="save()">保存</button> <button onclick="nextstep()">下一步</button></div></footer>
    </div>
    <script type="text/javascript">
        init();
        function init() {
            Reqdata("/rd?ls=config&type=ethnic", "", function (res) { g_ethnic = res.data; });
            Reqdata("/curuserinf", "", function (res) {
                g_user = res.data;
                $("#main").html(xruserform(g_user,res.fields));
            });
        }

        function xruserform(user, fields) {
            var ui2 = `
                <div style="float:left;display:block;height:240px;width:280px;margin-top:5px;">
                    <div style="float:left;display:block;">
                        <label class="imagelive" style="height:78px;width:78px;" for="face">
                            <img style="width:100%;height:100%;"  {face} >
                            <input type="file" id="face" name="face" accept="image/*">
                        </label>
                    </div>
                    <div class="x2Form narrow">
                        <div style="margin-top:0px;"><label>帐号</label><div style="display:inline-block;">{account}</div></div>
                        <div style="position:relative;">
                            <label>密码</label>
                            <div class="xCombox" style="border: 1px solid #95b7ff;">
                                <label style="color:royalblue;margin:0px;">点击修改</label>
                                <div class="xPopWnd" style="left: -6px; width: 200px; height: 115px; padding: 5px; display: none;">
                                    <label style="margin-right:5px;">旧密码</label><input name="pwd" type="password" style="width:140px;height:20px;">
                                    <label style="margin-right:5px;">新密码</label><input name="newpwd1" type="password" style="width:140px;height:20px;">
                                    <label style="margin-right:5px;">新密码</label><input name="newpwd2" type="password" style="width:140px;height:20px;">
                                    <div style="float:right"><input type="button" onclick="hidechgpwd(this)" value="确定"/> <input type="button" onclick="hidechgpwd(this)" value="取消" /></div>
                                </div>
                            </div>
                        </div>
                    </div><label class="imagelive" style="width:280px;height:160px;margin-top:5px" for="idimg">
                        <img style="width:100%;height:100%;" {idimg} >
                        <input type="file" id="idimg" name="idimg" accept="image/*">
                    </label>
                </div>`;

            return ui2.format({ "account": user.account, face: (user.face == "" ? "" : 'src="' + user.face + '"'),
                idimg: (user.idimg == "" ? "" : 'src="' + user.idimg + '"')}) + RenderForm4(g_user, fields, function (user, field) {
                var name = field.name ? field.name : field;
                var val = user[name];
                if (field.name == "sex") return RenderSelect(db_sex, val);
                else if (field.name == "job") return RenderSelect(GetsubJob(g_user.job, "array"), val);
                else if (field.name == "ethnic") return RenderSelect(g_ethnic, val);
                else return user[name];
            });
        }

        function hidechgpwd(This) {
            if ($(This).attr("value") != "确定") {
                $(This).parent().parent().css("display", "none");
                return;
            }

            var formdata = new FormData(document.getElementById("main"));
            var pwd = formdata.get("pwd");
            var password1 = formdata.get("newpwd1");
            var password2 = formdata.get("newpwd2");
            if (password1 != password2) {
                alert("两次输入的密码不一致！");
                return;
            }

            var val = `{"id":"{id}","pwd":"{pwd}","newpwd":"{newpwd}"}`.format({
                "id": g_user.id, "pwd": pwd, "newpwd": password1 });
            ReqdataP("/chgpwd", val, "修改密码", function (jsn) {
                if (jsn.result != 200) {
                    alert(jsn.msg);
                    return;
                }
                alert("修改成功！");
                $(This).parent().parent().css("display", "none");
            });
        }

        function save() {
            delete g_chged.pwd;
            delete g_chged.newpwd1;
            delete g_chged.newpwd2;

            var formdata = new FormData(document.getElementById("main"));
            var fd = new FormData();
            for (var x in g_chged) {
                if (x == "face" || x == "idimg")
                    fd.append(x, $("#"+x).get(0).files[0]);
                else 
                    fd.append(x, formdata.get(x));
            }

            var xhr = new XMLHttpRequest();
            xhr.onreadystatechange = function () {
                if (xhr.readyState == 4 && xhr.status == 200) {
                    alert('保存成功' + xhr.responseText);
                }
            };
            xhr.open('POST', '/wt?ls=user&id='+g_user.id, true);
            xhr.send(fd);
        }
        function nextstep() {
            return window.location.href = '/static/user_init2.html'
        }
        var g_chged = new Object();
        $("html").on("change", function () {
            var node = event.target;
            if (node.tagName == "INPUT")
                g_chged[$(node).attr("name")] = true;
        });
    </script>
</body>
</html>

<!--
input：普通录入
pwd：密码
image：图片
select：所在单位选择，职位选择，领域选择，籍贯（省地市）选择，
input
choice：性别选择，
date：日历，
image-->