<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>啄木鸟风电维保系统</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <link rel="stylesheet" href="css/bootstrap.css" />
    <script src="js/jquery.js"></script>
    <script src="js/bootstrap.js"></script>
    <script type="text/javascript" src="js/doTe.js"></script>
    <script src="js/utils.js"></script>
    <link rel="stylesheet" href="css/xpecker.css" />
    <script src="js/Cube.js"></script>
    <script src="js/db.js"></script>
    <script src="js/xpecker.js"></script>

    <script src="laydate/laydate.js"></script>
    <style>/*为了解决BootStrap中css和layDate的css样式冲突*/
        .laydate_box, .laydate_box * {box-sizing: content-box;}
        .laydate_box th {text-align: center;}
    </style>

    <link rel="stylesheet" href="css/matio.css" />
    <style>
        .formtitle {
            font-size: 36px;
            margin-top: 20px;
            height: 58px;
            min-width: 170px;
            margin-left: 50px;
            text-align: center;
        }

        .xTable input, .xTable select {border: 0px;}
    </style>
</head>
<body class="xFCsrow">
    <section class="xPanel2 xFIfixed" style="width: 600px;">
        <header>出库单列表</header>
        <div id="g_matouts_whin" class="xScroll" style="padding: 5px;height:100px;flex-grow: 1;"></div>
    </section>
    <section class="xPanel2">
        <header>出库单</header>
        <div class="xScroll" style="padding: 5px;height:100px;flex-grow: 1;">
            <header class="xFCsrow">
                <div id="sect_creater" class="xFIfixed x2Form" style="width:300px;margin-top:50px;">
                    <div><label>备货人</label><div id="stocker">　</div></div><div><label>备货时间</label><div id="stockdate">　</div></div>
                </div>
                <div style="text-align:center;">
                    <div id="usage"><div class="formtitle" value="">出库单</div></div>
                    <div id="sect_code" class="x2Form"><div><label>单号</label><input id="code" /></div></div>
                </div>
                <div id="sect_request" class="xFIfixed x2Form" style="width:300px;margin-top:10px;">
                    <div><label>故障单号</label><div>　</div></div><div><label>申请人</label><div id="creater">　</div></div><div><label>申请时间</label><div id="createdate">　</div></div>
                </div>
            </header>
            <div id="recs_table" style="margin:20px;">
                <table class="xTable">
                    <thead><tr><th>编号</th><th>材料名称</th><th>类型</th><th>计量单位</th><th>数量</th><th>规格</th><th>生产厂家</th><th>生产日期</th><th>失效日期</th><th>备注</th></tr></thead>
                    <tbody>
                        <tr><td>1</td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr>
                        <tr><td>2</td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr>
                        <tr><td>3</td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr>
                        <tr><td>4</td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr>
                        <tr><td>5</td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr>
                        <tr><td>6</td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr>
                        <tr><td>7</td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr>
                        <tr><td>8</td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr>
                        <tr><td>9</td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr>
                        <tr><td>0</td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr>
                    </tbody>
                </table>
            </div>
            <footer class="xFCsrow" sstyle="margin-top:20px;">
                <div id="sect_checker" class="xFIfixed x2Form" style="width:600px;">
                    <div><label>备注</label><input id="remark" style="width:490px;" /></div>
                    <div><label>审核人</label><div id="checker">　</div></div><div><label>审核时间</label><div id="checkdate">　</div></div>
                </div>
                <div></div>
                <div id="sect_whout" class="xFIfixed x2Form" style="width:300px;">
                    <div><label>发货人</label><div id="shipper">　</div></div><div><label>发货时间</label><div id="shipdate">　</div></div>
                </div>
            </footer>
            <div id="sect_flowlist" style="margin-top:50px;"></div>
        </div>
    </section>

    <script type="text/javascript">
        var g_user = parent.g_user, g_mats, g_users = [], g_clerks, g_guides, g_matin, g_matins;
        if (g_user == undefined)
            g_user = GetRoleUser("仓库主管");

        var g_recfields = [{ name: "code", title: "编号", ftype: "div", width: "90px" }, { name: "name", title: "材料名称", ftype: "select", width: "120px" },
        { name: "type", title: "类型", ftype: "div", width: "80px" }, { name: "unit", title: "计量单位", ftype: "div", width: "40px" },
        { name: "num", title: "数量", ftype: "input", width: "40px" }, { name: "specs", title: "规格", ftype: "input", width: "60px" },
        { name: "vender_id", title: "生产厂家", ftype: "select", width: "80px" }, { name: "producedt", title: "生产日期", ftype: "date", width: "80px" },
        { name: "expiredt", title: "失效日期", ftype: "date", width: "80px" }, { name: "remark", title: "备注", ftype: "input", width: "300px" }];


        ReqdataS("/rd?ls=mat", "", function (mats) {g_mats = mats;});
        Reqdata("/rd?ls=vender&type=" + GetSub(db_tbl, "name", "mat").id, "", function (res) { g_matvenders = res; });
        Reqdata("/rduser?depart_table=" + GetSub(db_tbl, "name", "matwh").id + "&depart_id=" + g_user.depart.id, "", function (res2) {
            g_clerks = res2;
            g_users = g_users.concat(res2.data);
        });
        Reqdata("/rduser?job=" + GetSub(db_job, "name", "调度").id, "", function (res2) {
            g_guides = res2;
            g_users = g_users.concat(res2.data);
        });
        // 查询所有的出库单
        Reqdata("/rd?ls=matout&matwh_id=" + g_user.depart.id, "", function (matouts) {
            g_matouts = matouts;
            $("#g_matouts_whin").html(RenderTable2(matouts, "", (data, field) => {
                if (field.name == "source") return GetSub(db_matsouce, "id",data["source"]).name;
                else return data[field.name];
            }));
            TableBindClick3(g_matouts.ls, onclickmatout);
        });

        function onclickmatout(matout_id) {
            var matout = GetSub(g_matouts.data, "id", matout_id);
            Reqdata("/rd?ls=outrecview&matout_id=" + matout_id, "", function (matoutrecs) {
                
                $("#usage").html('<div class="formtitle">{0}</div>'.format(f2s(matout, "usage")));
                $("#sect_code").html(RenderPaneIn(matout, [GetSub(g_matouts.fields, "name", "code")]));
                $("#recs_table").html(RenderTable2({ fields: g_recfields, data: matoutrecs.data }, "", f2sRec));

                var remark = '<label>备注</label><div id="remark" style="width:490px;" >{0}</div>'
                $("#remark").parent().html(remark.format(matout.remark));
            });

            var request = `<div><label>故障单号</label><div>{fault_id}</div></div><div><label>申请人</label>
                    <div id="creater">{creater}</div></div><div><label>申请时间</label><div id="createdate">{createdate}</div></div>`
            if (matout.fault_code == "")
                $("#sect_request").html(request.format({ fault_id: '　', creater: '　', createdate: '　', }));
            else {
                $("#sect_request").html(request.format({
                    fault_id: matout.fault_id, creater: '　', createdate: '　'}));
            }

            // 流水
            Reqdata("/rd?ls=flow&table_id=" + GetTbl("matout").id + "&record_id=" + matout.id, "", function (flows) {
                // 填流表单上的四项操作员、操作日期
                var oper = [{ status: "0", name: "creater", date: "createdate" },{ status: "2", name: "stocker", date: "stockdate" },
                { status: "4", name: "checker", date: "checkdate" }, { status: "5", name: "shipper", date: "shipdate" }];
                oper.map(x => { $("#" + x.name).html("　"); $("#" + x.date).html("　"); });
                var loglist = "";
                $.each(flows.data, (i, x) => {
                    $.each(oper, (j, y) => {
                        if (x.status == 0 && matout.fault_code =="")
                            return;
                        if (x.status == y.status) { $("#" + y.name).html(f2s(x, "user_id")); $("#" + y.date).html(x.date); }
                    });
                    loglist += "<div>" + x.date + " " + f2s(x, "user_id") + " " + x.remark + "</div>";
                });
                $("#sect_flowlist").html(loglist);
            });
        }

        function RenderPaneIn(data, fields) {
            var r = "";
            for (var i = 0, field = fields[0]; i < fields.length; i++ , field = fields[i]) {
                var attr = "";
                if (field.ftype == "input_long")
                    attr += 'style="width:490px;"';
                else if (field.ftype == "textarea")
                    attr += 'style="overflow-y: scroll;width:490px;max-height:45px;"';

                r += "<div><label>" + field.title + "</label><div " + attr + ">" + data[field.name] + "</div></div>";
            }
            return r;
        }

        function f2s(data, field) {
            if (typeof field != "string")
                field = field.name;
            if (field == "stocker_id") return GetSub(g_users, "id", data[field]).name;
            else if (field == "creater_id") return GetSub(g_users, "id", data[field]).name;
            else if (field == "user_id") return GetSub(g_users, "id", data[field]).name;
            else if (field == "mat_id") return GetSub(g_mats.data, "id", data[field]).name;
            else if (field == "unit") return GetSub(g_mats.data, "id", data["mat_id"]).unit;
            else return data[field];
        }

        function f2sRec(data, field) {
            if (field.name == "code") return GetSub(g_mats.data, "id", data["mat_id"]).code;
            else if (field.name == "name") return GetSub(g_mats.data, "id", data["mat_id"]).name;
            else if (field.name == "type") return GetSub(g_mats.data, "id", data["mat_id"]).type;
            else if (field.name == "unit") return GetSub(g_mats.data, "id", data["mat_id"]).unit;
            else if (field.name == "vender_id") return GetSub(g_matvenders.data, "id", data["vender_id"]).name;
            else return data[field.name];
        }

        // 表单验证的几种方法： http://www.jb51.net/article/92741.htm
    </script>
</body>
</html>

