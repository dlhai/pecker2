<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>啄木鸟风电维保系统</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <script src="js/jquery.js"></script>
    <link rel="stylesheet" href="css/bootstrap.css"/>
    <script src="js/bootstrap.js"></script>
    <script type="text/javascript" src="js/doTe.js"></script>
	<script src="laydate/laydate.js"></script>
	<script src="js/utils.js"></script>
    <link rel="stylesheet" href="css/cube.css"/>
    <script src="js/Cube.js"></script>
    <script src="js/db.js"></script>
    <link rel="stylesheet" href="css/xpecker.css" />
    <script src="js/xpecker.js"></script>

    <style>
        .narrow>div>div:first-of-type,.narrow>div>input:first-of-type {width: 136px;}
        .narrow>div>label:first-of-type {width: 40px;}
        .narrow>div,.narrow>div>div:first-of-type {margin-right: 0px;}
        .live {
            background: #808080;
            border: 0px;
        }

        .title {
            display: inline-block;
            border-radius: 4px;
            padding: 4px 15px;
            border: 1px solid #dddddd;
        }

    </style>

    <style>
        .pane_image>div {
            margin: 5px 0px 5px 5px;
            display: inline-flex;
            flex-direction: row;
            align-items: flex-start;
            border: 0px;
        }
        .pane_image>div>label {
            width: 40px;
            text-align: right;
            margin: 5px;
        }
        .pane_image>div>div:first-of-type {
            border-radius: 4px;
            border: 1px solid #dddddd;
            display: inline-block;
            padding: 5px 10px;
            margin: 0px 5px;
            width: 137px;
        }
    </style>

</head>
<body class="xFCsrow">
    <section class="xPanel2"  style="width:100px"><!--两个子项都固定宽度100，使它们获得相同的增量-->
        <header class="xFIfixed">设备列表<div style="float: right;"><a href="javascript:onNewDev()">新建</a> <a href="javascript:onEditDev()">编辑</a></div></header>
        <div id="item_list" class="xScroll" style="padding: 5px;height:100px;flex-grow: 1;"></div>
    </section>

    <div id="curitem" class="xFCscol"  style="width:100px;">
        <section class="xPanel2 xFIfixed">
            <header>设备信息<div style="float: right;"><a href="javascript:onEditDev()">编辑</a></div></header>
            <div id="item_detail" style="padding:5px;"></div>
        </section>
        <section class="xPanel2">
            <header class="xFIfixed">任务列表</header>
            <div id="tasklist" class="xScroll" style="padding: 5px;height:100px;flex-grow: 1;"></div>
        </section>
    </div>

    <script id="tpl_dev_pane" type="text/template">
        <div style="height:240px;width:280px;float: left; display:block;">
            <div class="pane_image" style="width: 100%; height: 80px; margin: 0px; padding:0px; display:block;border:0px;">
                <div style="float: left; margin:0px;"><img style="width: 78px; height: 78px;" src="{%=it.face%}" /></div>
                <div style="margin-top:0px;"><label>编号</label><div style="display:inline-block;">{%=it.code%}</div></div>
                <div><label>分类</label><div>{%=f2s(it,"clss")%}</div></div>
            </div>
            <img style="width: 280px; height: 160px;" src="{%=it.img%}" />
        </div>
    </script>

    <script id="tpl_dev_form" type="text/template">
        <div style="height:240px;width:280px;float: left; display:block;">
            <div class="pane_image" style="width: 100%; height: 80px; margin: 0px; padding:0px; display:block;border:0px;">
                <div style="float: left; margin:0px;">
                    <label class="imagelive" style="display:inline-block;width:78px;margin:0px;" for="SelectFace"> 
						<img id="viewface" style="width: 78px; height: 78px;;z-index: 999;" src="{%=it.face%}" />
						<input type="file" id="SelectFace" accept="image/*" style="display:none;" onchange="imgPreview(this,'viewface')">
					</label>
                </div>
                <div style="margin-top:0px;"><label>编号</label><div style="display:inline-block;">{%=it.code%}在</div></div>
                <div style="position:relative;">
                    <label>分类</label><select>{%=f2e(it,GetSub(g_devs.fields, "name", "clss"))%}</select>
                </div>
            </div>
            <label class="imagelive" style="display:inline-block;" for="selectidimg">
				<img id="viewidimg" style="width: 280px; height: 160px;z-index: 999;" src="{%=it.img%}" /> 
				<input type="file" id="selectidimg" accept="image/*" style="display:none;" onchange="imgPreview(this,'viewidimg')">
			</label>
        </div>
    </script>

    <script type="text/javascript">
        var tpl_dev_pane = doT.template(document.getElementById('tpl_dev_pane').innerHTML);
        var tpl_dev_form = doT.template(document.getElementById('tpl_dev_form').innerHTML);
        var g_devwhs, g_devs, g_devvenders, g_drivers, g_guiders, g_users,g_focus;
        var g_user = parent.g_user;
        if (g_user == undefined) {
            Reqdata("/curuserinf", "", function (res) {
                g_user = res.data;
                g_user.fields = res.fields;
                init();
            });
        }
        else {
            init();
        }

        function init() {
            Reqdata("/rd?ls=vender&type=21", "", function (res) { g_devvenders = res; });
			Reqdata("/user/briefs?job=(11,12)", "", function (res) { g_guiders = res; });
            Reqdata("/rduser?job=(5,6)&depart_id=" + g_user.depart.id, "", function (res) { g_driver = res; });
            Reqdata("/rd?ls=dev&devwh_id=" + g_user.depart.id, "", function (res3) {
                g_devs = res3;
                GetSub(g_devs.fields, "name", "code").ftype = "none";
                GetSub(g_devs.fields, "name", "clss").ftype = "none";
                GetSub(g_devs.fields, "name", "devwh_id").twidth = 0;
                GetSub(g_devs.fields, "name", "producedate").twidth = 0;
                GetSub(g_devs.fields, "name", "buydate").twidth = 0;
                $("#item_list").html(RenderTable2(g_devs, undefined, f2s));
            });
        }
		// 表格单击
        $("html").on("click", function (event) {
            var td = $(event.target);
            if (td[0].localName == "td" && td.parents(".xTable").length > 0) {
                g_focus = GetSub(g_devs.data, "id", GetCurRowDataID(g_devs.ls));
                //var pane = tpl_dev_pane(g_focus)+RenderPane2(g_focus, g_devs.fields, f2s);
                $("#item_detail").html(devpane(g_focus,g_devs.fields));

                // 任务记录
                Reqdata("/rd?ls=devwork&dev_id=" + g_focus.id, "", function (works) {
                    GetSub(works.fields, "name", "remark").twidth = 0;
                    GetSub(works.fields, "name", "devwh_id").twidth = 0;
                    GetSub(works.fields, "name", "clss").twidth = 0;
                    GetSub(works.fields, "name", "dev_id").twidth = 0;
                    GetSub(works.fields, "name", "driver_id").twidth = 0;
                    $("#tasklist").html(RenderTable2(works, undefined, workf2s));
                });
            }
        });

		function workf2s(data, field) {
			var fn = field.name;
            if (fn == "clss") return data[fn] == "" ? "" :GetSub(db_devclss, "id", data[fn]).name;
            else if (fn == "status") return data[fn] == "" ? "" :GetSub(status_devwork, "id", data[fn]).name;
            else if (fn == "deal_id") return data[fn] == "" ? "" :GetSub(g_driver.data, "id", data[fn]).name;
            else if (fn == "guide_id") 
				return data[fn] == "" ? "" :GetSub(g_guiders.users, "id", data[fn]).name;
            else return data[fn];
        }

        function f2s(data, field) {
			var fn = (typeof field == "string") ? field : field.name;
            if (fn == "clss") return data[fn] == "" ? "" :GetSub(db_devclss, "id", data[fn]).name;
            else if (fn == "devwh_id") return g_user.depart.name;
            else if (fn == "status") return data[fn] == "" ? "" :GetSub(status_dev, "id", data[fn]).name;
            else if (fn == "vender_id") return data[fn] == "" ? "" :GetSub(g_devvenders.data, "id", data[fn]).name;
            else if (fn == "driver_id") return data[fn] == "" ? "" :GetSub(g_driver.data, "id", data[fn]).name;
            else return data[fn];
        }
        function f2e(data, field) {
            if (field.name == "clss") return RenderSelect(db_devclss, data[field.name]);
            else if (field.name == "devwh_id") return g_user.depart.name;
            else if (field.name == "status") return RenderSelect(status_dev, data[field.name]);
            else if (field.name == "vender_id") return RenderSelect(g_devvenders.data, data[field.name]);
            else if (field.name == "driver_id") return RenderSelect(g_driver.data, data[field.name]);
            else return data[field.name];
        }

        function onNewDev() {
            var title = "新建 设备";
            var u = Create(g_devs.fields);
            u.devwh_id = g_focus.data[0].id;
            var cnt = RenderForm4(u, g_devs.fields, f2e);

			var dlg = new cbFormDlg(title, "width:610px", cnt);
			dlg.urlsubmit = "/dev/devcreate";
			dlg.closing = function (reason){
				Reqdata("/rd?ls=dev&devwh_id=" + g_focus.data[0].id, "", function (res) {
					g_devs = res;
					$("#subitem_list").html(RenderTable2(res, "", f2s));
				});
			}
            dlg.Show();
		}
        function onEditDev(){
            var title = "编辑 设备";
            var idx = GetIdx(g_devs.data, "id", GetCurRowDataID(g_devs.ls));
            //var cnt = RenderForm4( g_devs.data[idx], g_devs.fields,f2e);
			var cnt = devform( g_devs.data[idx], g_devs.fields);

			var dlg = new cbFormDlg(title, "width:910px", cnt);
            dlg.urlsubmit = "/dev/devmodify?id=" + g_devs.data[idx].id;
            dlg.urlremove = "/dev/devremove?id=" + g_devs.data[idx].id;
			dlg.closing = function (reason){
				if ( reason == "remove")
					g_devs.data.splice(idx, 1); 
                else if (reason == "submit")
					g_devs.data[idx] = dlg.res.data[0];
				$("#subitem_list").html(RenderTable2(g_devs, "", f2s));
			}
            dlg.Show();
		}

        function imgPreview(fileDom, idimg) {
            var file = fileDom.files[0];
            var reader = new FileReader();
            reader.onload = function (e) { $("#" + idimg).attr("src", e.target.result); };
            reader.readAsDataURL(file);
        }

		function devpane(dev, fields) {
			var ui2 = `
				<div style="float:left;display:block;height:240px;width:280px;margin-top:5px;margin-left:10px;">
					<div style="float:left;display:block;height:78px;width:78px;">
						<img style="width:100%;height:100%;" src="{face}">
					</div>
					<div class="x2Form narrow">
						<div style="margin-top:0px;"><label>编号</label><div style="display:inline-block;">{code}</div></div>
						<div><label>分类</label><div>{clssname}</div></div>
					</div>
					<div style="width:280px;height:160px;margin-top:5px">
						<img style="width:100%;height:100%;" src="{img}" >
					</div>
				</div>`;
			dev.clssname=f2s(dev,"clss");
			return ui2.format(dev) + RenderPane3(dev, fields, f2s);
		}

		function devform(dev, fields) {
			var ui2 = `
				<div style="float:left;display:block;height:240px;width:280px;margin-top:5px;margin-left:10px;">
					<div style="float:left;display:block;">
						<label class="imagelive" style="height:78px;width:78px;" for="face">
							<img style="width:100%;height:100%;"  src="{face}" >
							<input type="file" id="face" name="face" accept="image/*">
						</label>
					</div>
					<div class="x2Form narrow">
						<div style="margin-top:0px;"><label>编号</label><input type="text" value="{code}" style="display:inline-block;" /></div>
						<div><label>分类</label><div>{clss}</div></div>
					</div>
					<label class="imagelive" style="width:280px;height:160px;margin-top:5px" for="idimg">
						<img style="width:100%;height:100%;" {idimg} >
						<input type="file" id="idimg" name="idimg" accept="image/*">
					</label>
				</div>`;
            return ui2.format(dev) + xCreateNode({ "name": "div", "class": "x2Form", "style": "min-height:250px;", "body": RenderFormIn(dev, fields, f2e) } );
		}
    </script>
</body>
</html>
