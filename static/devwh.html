<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>啄木鸟风电维保系统</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <script src="js/jquery.js"></script>
    <link rel="stylesheet" href="css/bootstrap.css"/>
    <script src="js/bootstrap.js"></script>
    <script type="text/javascript" src="js/doTe.js"></script>
    <script src="js/utils.js"></script>
    <script src="js/Cube.js"></script>
    <script src="js/db.js"></script>
    <link rel="stylesheet" href="css/xpecker.css" />
    <script src="js/xpecker.js"></script>
    <style>
        .pane_image>div {
            margin: 5px 0px 5px 5px;
            display: inline-flex;
            flex-direction: row;
            align-items: flex-start;
            border: 0px;
        }
        .pane_image>div>label {
            width: 40px;
            text-align: right;
            margin: 5px;
        }
        .pane_image>div>div:first-of-type {
            border-radius: 4px;
            border: 1px solid #dddddd;
            display: inline-block;
            padding: 5px 10px;
            margin: 0px 5px;
            width: 137px;
        }

        /*图片框无图时的背景十字架图片*/
        .ImgBlank {
            position: relative;
            background: url(img/add.png);
            background-size: cover;
        }
    </style>

</head>
<body class="xFCsrow">
    <section class="xPanel2"  style="width:100px"><!--两个子项都固定宽度100，使它们获得相同的增量-->
        <header class="xFIfixed">设备列表<div style="float: right;"><a href="javascript:onNewDev()">新建</a> <a href="javascript:onEditDev()">编辑</a></div></header>
        <div id="item_list" class="xScroll" style="padding: 5px;height:100px;flex-grow: 1;"></div>
    </section>

    <div id="curitem" class="xFCscol"  style="width:100px;">
        <section class="xPanel2 xFIfixed">
            <header>设备信息<div style="float: right;"><a href="javascript:onEditDev()">编辑</a></div></header>
            <div id="item_detail" class="x2Form" style="padding:5px;"></div>
        </section>
        <section class="xPanel2">
            <header class="xFIfixed">任务列表</header>
            <div id="tasklist" class="xScroll" style="padding: 5px;height:100px;flex-grow: 1;"></div>
        </section>
    </div>

    <script id="tpl_dev_pane" type="text/template">
        <div style="height:240px;width:280px;float: left; display:block;">
            <div class="pane_image" style="width: 100%; height: 80px; margin: 0px; padding:0px; display:block;border:0px;">
                <div style="float: left; margin:0px;"><img style="width: 78px; height: 78px;" src="{%=it.face%}" /></div>
                <div style="margin-top:0px;"><label>编号</label><div style="display:inline-block;">{%=it.code%}</div></div>
                <div><label>分类</label><div>{%=it.clss%}</div></div>
            </div>
            <img style="width: 280px; height: 160px;" src="{%=it.img%}" />
        </div>
    </script>

    <script id="tpl_dev_form" type="text/template">
        <div style="height:240px;width:280px;float: left; display:block;">
            <div class="pane_image" style="width: 100%; height: 80px; margin: 0px; padding:0px; display:block;border:0px;">
                <div style="float: left; margin:0px;">
                    <label class="ImgBlank" style="display:inline-block;width:78px;margin:0px;" for="SelectFace"> <img id="viewface" style="width: 78px; height: 78px;;z-index: 999;" src="{%=it.face%}" /> </label>
                    <input type="file" id="SelectFace" accept="image/*" style="display:none;" onchange="imgPreview(this,'viewface')">
                </div>
                <div style="margin-top:0px;"><label>编号</label><div style="display:inline-block;">{%=it.code%}在</div></div>
                <div style="position:relative;">
                    <label>分类</label><select>{%=FieldToEdit(it,GetSub(g_devs.fields, "name", "clss"))%}</select>
                </div>
            </div>
            <label class="ImgBlank" style="display:inline-block;" for="selectidimg"> <img id="viewidimg" style="width: 280px; height: 160px;z-index: 999;" src="{%=it.img%}" /> </label>
            <input type="file" id="selectidimg" accept="image/*" style="display:none;" onchange="imgPreview(this,'viewidimg')">
        </div>
    </script>

    <script type="text/javascript">
        var tpl_dev_pane = doT.template(document.getElementById('tpl_dev_pane').innerHTML);
        var tpl_dev_form = doT.template(document.getElementById('tpl_dev_form').innerHTML);
        var g_devwhs, g_devs, g_devvenders, g_user = parent.g_user, g_driver, g_editmode = false;;
        if (g_user == undefined)
            g_user = GetRoleUser("驻地主管");

        Reqdata("/rd?ls=vender&type=" + GetSub(db_tbl, "name", "dev").id, "", function (res1) { g_devvenders = res1; });
        Reqdata("/rduser?depart_table=" + GetSub(db_tbl, "name", "devwh").id + "&depart_id=" + g_user.depart.id, "", function (res2) { g_driver = res2; });
        Reqdata("/rd?ls=dev&devwh_id="+g_user.depart.id, "", function (res3) {
            g_devs = res3;
            GetSub(g_devs.fields, "name", "code").forder = -1;
            GetSub(g_devs.fields, "name", "clss").forder = -1;
            GetSub(g_devs.fields, "name", "devwh_id").twidth = 0;
            GetSub(g_devs.fields, "name", "producedate").twidth = 0;
            GetSub(g_devs.fields, "name", "buydate").twidth = 0;
            $("#item_list").html(RenderTable2(g_devs, undefined, FieldToShow));
            TableBindClick3(g_devs.ls, function (id) {
                g_curdev = GetSub(g_devs.data, "id", id);
                var pane = tpl_dev_pane(g_curdev);
                pane += RenderPane2(g_curdev, g_devs.fields, FieldToShow);
                $("#item_detail").html(pane);

                // 任务记录
                Reqdata("/rd?ls=devwork&dev_id=" + id, "", function (works) {
                    $("#tasklist").html(RenderTable2(works, undefined, function (data, field) {
                        if (field.name == "clss") return GetSub(db_devclss, "id", data[field.name]).name;
                        else if (field.name == "devwh_id") return g_user.depart.name;
                        else if (field.name == "status") return GetSub(db_devwork_status, "id", data[field.name]).name;
                        else if (field.name == "dev_id") return GetSub(g_devs.data, "id", data[field.name]).name;
                        else if (field.name == "driver_id") return GetSub(g_driver.data, "id", data[field.name]).name;
                        else return data[field.name];
                    }));
                });
            });
        });
        function FieldToShow(data, field) {
            if (field.name == "clss") return GetSub(db_devclss, "id", data[field.name]).name;
            else if (field.name == "devwh_id") return g_user.depart.name;
            else if (field.name == "status") return GetSub(db_devstatus, "id", data[field.name]).name;
            else if (field.name == "vender_id") return GetSub(g_devvenders.data, "id", data[field.name]).name;
            else if (field.name == "driver_id") return GetSub(g_driver.data, "id", data[field.name]).name;
            else return data[field.name];
        }
        function FieldToEdit(data, field) {
            if (field.name == "clss") return RenderSelect(db_devclss, data[field.name]);
            else if (field.name == "devwh_id") return RenderSelect([g_user.depart], data[field.name]);
            else if (field.name == "status") return RenderSelect(db_devstatus, data[field.name]);
            else if (field.name == "vender") return RenderSelect(g_devvenders.data, data[field.name]);
            else return data[field.name];
        }

        function onNewDev() {
            var dev = Create(g_devs.fields);
            var form = '<div class="x2Form">';
            form += tpl_dev_form(dev);
            form += RenderFormIn(dev, g_devs.fields, FieldToEdit);
            form += "</div>";
            (new cbDlg("新建 设备", "width:900px", form)).Show();
        }
        function onEditDev() {
            var dev = g_curdev;
            var form = '<div class="x2Form">';
            form += tpl_dev_form(dev);
            form += RenderFormIn(dev, g_devs.fields, FieldToEdit);
            form += "</div>";
            (new cbDlg("编辑 设备", "width:900px", form)).Show();
        }

        function imgPreview(fileDom, idimg) {
            var file = fileDom.files[0];
            var reader = new FileReader();
            reader.onload = function (e) { $("#" + idimg).attr("src", e.target.result); };
            reader.readAsDataURL(file);
        }

    </script>
</body>
</html>
