<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>啄木鸟风电维保系统</title>
    <script src="js/jquery.js"></script>
    <link rel="stylesheet" href="css/bootstrap.css"/>
    <script src="js/bootstrap.js"></script>
    <script type="text/javascript" src="js/doTe.js"></script>
	<script src="laydate/laydate.js"></script>
    <script charset="utf-8" src="kindedit/kindeditor-all.js"></script>
    <script charset="utf-8" src="kindedit/lang/zh-CN.js"></script>
    <script src="js/utils.js"></script>
    <script src="js/db.js"></script>
    <link rel="stylesheet" href="css/xpecker.css" />
    <script src="js/xpecker.js"></script>
    <link rel="stylesheet" href="css/Cube.css" />
    <script src="js/Cube.js"></script>
	<link rel="stylesheet" href="css/speech.css" />
    <link rel="StyleSheet" href="css/case.css" type="text/css" />
    <link rel="StyleSheet" href="css/matio.css" type="text/css" />
	<script src="js/coord.js"></script>
	<script src="js/coord_matout.js"></script>

	<style>
		/*出库单标题*/
        .formtitle {
            font-size: 36px;
            margin-top: 20px;
            height: 58px;
            min-width: 170px;
            margin-left: 50px;
            text-align: center;
        }
		.buttonarray button{display:none;}


		.radio_group{
            display: inline-block;
			margin:0px;
			vertical-align: top;
		}
		.radio_group>div{
            padding: 5px 10px 5px 10px;
			font-size: 14px;
            line-height: 20px;
            color: #777777;
            position: relative;
            display: inline-block;
			margin:0 1px;
			border-bottom: 1px solid #e5e5e5;
		}
        .radio_group>.active, .radio_group>div:hover, .radio_group>div:focus {
            color: #555555;
            background-color: #d5d5d5;
        }
	</style>



</head>
<body class="xFCsrow">
    <section class="xPanel2 xFIfixed" style="width:300px;">
        <header>任务列表<div style="float: right;"></header>
        <div id="troublelist" class="xScroll" style="height:100px;flex-grow: 1;"></div>
    </section>
    <section class="xPanel2" style="width: 700px; max-width:900px;">
        <header>案件处理</header>
        <div id="case" class="xScroll" style="height:100px;flex-grow: 1;padding:0px;">
        </div>
    </section>
    <section class="xPanel2 xFIfixed" style="width:200px;min-width:160px;">
        <header>参与人员<div style="float: right;"><a id="btn_chatmen">管理</a></div></header>
        <div id="chatman" class="xScroll" style="height:100px;flex-grow: 1;"></div>
    </section>
    <section class="xPanel2" style="width: 450px; min-width: 300px;">
        <header>对话</header>
		<div id="speechlist" class="xScroll" style="height:100px;flex-grow: 1;"></div>
		<footer id="speechinput" class="xFCsrow xFIfixed" style="padding:0px 10px 10px 0px; height: 200px; width: 100%; align-items: flex-end;">
			<textarea id="kereplay" class="xrAngle" style="margin-right:10px; padding:5px 10px; height:188px;width:100px;resize:none;"></textarea>
			<div class="xFIfixed"><button onclick="onsend()">发送</button></div>
		</footer>
    </section>

<script type="text/javascript">
    var g_focus_card, g_focus, g_faults, g_focus_matrec,g_mats,g_matwhs;
	var g_user = parent.g_user;
	if (g_user == undefined) {
		Reqdata("/curuserinf", "", function (res) {
			g_user = res.data;
			g_user.fields = res.fields;
			init();
		});
	}
	else{
		init();
	}
	function init(){
		$("body").on("click", function (event) { // 按钮事件
			var node = $(event.target);
			var id = node.attr("id");
			if ( id != undefined && id.indexOf("btn_") == 0 ){
				if ( node.parents(".buttonarray").length>0)
					onclickButton_matout(node);
				else
					onclickButton(node);
			}
		});
		$("body").on("change", function (event) { // 文件上传
			var node = event.target;
			if (node.tagName == "INPUT" && node.type == "file") {
				var doctype = $(node).parents(".buttonright").attr("id");
				if (doctype != undefined){ // 躲开现场记录中的图片列表
					var file = $(node).get(0).files[0];
					var formData = new FormData();
					formData.append("id", g_focus.fault.id);
					formData.append("doctype", doctype);
					formData.append("file", file);
					postform("/case/adddoc", formData, "", function (res) {RenderCase(g_focus.fault.id);});
				}
			}
		});

		Reqdata("/rd?ls=mat", "", function (mats) {g_mats = mats;});
		Reqdata("/rd?ls=matwh", "", function (res) {g_matwhs = res;});

		var int=self.setInterval( checkchange,10000);
		checkchange();
	}

	var kereplay;
	KindEditor.ready(function (K) {
		kereplay = K.create('#kereplay', {
			uploadJson: '/cr', resizeMode:0,items: ['cut', 'copy', 'paste', '|', 'formatblock', 'fontname', 'fontsize', 'forecolor', 'hilitecolor', 'bold', 'italic',
				'underline', 'removeformat', '|', 'link', 'unlink', '|', 'fullscreen',]
		});
	});

	function checkchange(){
		Reqdata("/case/rdfault"+ (g_faults == undefined? "":"?maxid="+g_faults.maxid), "", function (res) {
			if (g_faults != undefined && g_faults.maxid == res.maxid)
				return; // 没有新数据
			g_faults = res;
            res.fields.push({ "title": "报修风机", "name": "devices", "forder": "5", "ftype": "div_long" });
            xfieldsort(res.fields);
			$("#troublelist").html((g_faults.data.map(x => crd_faultcard(x)).join("")));
			$(".fault_card").on("click", onclickcard);

			if ( g_focus != undefined){ // 恢复之前的选中状态
				$("[data_id="+g_focus.fault.id+"]").children(".header").css("background", "linear-gradient(to bottom, rgba(233,209,154,1) 0%,rgba(208,157,80,1) 100%)");
			}
		});
	}

    function onclickcard(event)
    {
		// 切换焦点
        if (g_focus_card != undefined)
            g_focus_card.children(".header").css("background", "linear-gradient(to bottom, rgba(192,215,140,1) 0%,rgba(118,170,73,1) 100%)");
		g_focus_card = $(event.target).parents(".fault_card");
        g_focus_card.children(".header").css("background", "linear-gradient(to bottom, rgba(233,209,154,1) 0%,rgba(208,157,80,1) 100%)");
		RenderCase(g_focus_card.attr("data_id"));
	}
	function RenderCase(id){
		Reqdata("/case/detail?id=" + id, "", function (res) {
			if (!g_faults.data.some(x=>x.id==id)){ // 在fault列表产生变动的情况下，如删除，退回、完工等，会出现id不在fault列表中
				$("#case").html("");
				$("#chatman").html("");
				$("#speechlist").hide();
				$("#speechinput").hide();
				return;
			}

			g_focus = res;
			g_focus.experts.forEach(x=>x.prof=GetSub(db_job, "id", x.job).sname);
			g_focus.engineers.forEach(x=>x.prof=GetSub(db_job, "id", x.job).sname);
			g_focus.repairlog_users.forEach(x=>x.prof=GetSub(db_job, "id", x.job).sname);
			g_focus.chatmen.forEach(x=>x.prof=GetSub(db_job, "id", x.job).sname);

	        var html = crd_render_fault(g_focus.fault, g_faults.fields);

			if (g_focus.fault.status == 0 ){
				html += `<div style="margin:20px;border-top:2px dashed #6a923d;padding-top:30px;">
							<button id="btn_modify" type="button" class="btn btn-primary">编辑</button>
							<div style="float: right;">
								<div id="sect_flow" class="x2Form" style="display:inline-block;">
									<div><label>意见</label><input id="note" style="width:400px;"/></div>
								</div>
								<button id="btn_submit" type="button" class="btn btn-primary">提交</button>
							</div>
						</div>`;//工具条
				$("#case").html(html);
				$("#chatman").html("");
				$("#speechlist").hide();
				$("#speechinput").hide();
			}
			else if (g_focus.fault.status == 1 ){
				if (g_user.job == 2 || g_user.job == 3){ // 风场长或驻场
					html += `<div style="margin:20px;border-top:2px dashed #6a923d;padding-top:30px;">
								<button id="btn_recall" type="button" class="btn btn-default" style="color:#aaaaaa;display">撤回</button>
							 </div>`;//工具条
				}
				else if (g_user.job == 11 || g_user.job == 12){ // 调度长或调度
					html += `<div style="margin:20px;border-top:2px dashed #6a923d;padding-top:30px;">
								<div style="float: right;">
									<div id="sect_flow" class="x2Form" style="display:inline-block;">
										<div><label>意见</label><input id="note" style="width:400px;"/></div>
									</div>
									<button id="btn_accept" type="button" class="btn btn-primary">接单</button>
									<button id="btn_decline" type="button" class="btn btn-primary">退回</button>
								</div>
							</div>`;//工具条
				}
				$("#case").html(html);
				$("#chatman").html("");
				$("#speechlist").html("");
				$("#speechlist").hide();
				$("#speechinput").hide();
			}
			else{
				$("#speechlist").show();
				$("#speechinput").show();
				html += `<details open class="xDetail2"><summary>准备</summary><div>`;
				html += rd_frozenleft("专家组",rd_buttonright("experts", g_focus.experts.map(x=>rd_brief(x)).join("")));
				html += rd_frozenleft("评估报告",rd_doc("eval1",g_focus.eval1rep)+rd_doc("eval2",g_focus.eval2rep));
				html += rd_frozenleft("维修方案",rd_doc2("plan",g_focus.repairplan,g_focus.repairplan_sign,g_focus.repairplan_signers));
				html += rd_frozenleft("维修队",rd_buttonright("works", g_focus.engineers.map(x=>rd_brief(x)).join("")));
				html += rd_frozenleft("维修用料",rd_buttonright("mats", g_focus.matoutrecs.map(x=>rd_matrec(x)).join("")));
				html += rd_frozenleft("维修设备",rd_buttonright("devs", g_focus.devworks.map(x=>rd_device(x)).join("")));
				html += `</div></details>`;
	
				if (g_focus.repairlog.length>0 || g_user.job == 16|| g_user.job == 17||g_user.job == 2 || g_user.job == 3){ // 队长或技工、风场长或驻场
					html += `<details open class="xDetail2"><summary>维修<div style="float: right;"><a id="btn_log" href="#">添加</a></div></summary><div id="repair_log">`;
					html += rd_repairlog(g_focus.repairlog, g_focus.repairlog_imgs, g_focus.repairlog_users);
					html += `</div></details>`;
				}
				if (g_focus.repairrep.length>0 || g_user.job == 16){ // 队长
					html += `<details open class="xDetail2"><summary>完工</summary><div>`
					html += rd_frozenleft("维修报告",rd_doc2("report",g_focus.repairrep,g_focus.repairrep_sign,g_focus.repairrep_signers));
					html += `</div></details>`;
				}

				if (g_user.job == 11 || g_user.job == 12){ // 调度长或调度
					html += `<div style="margin:20px;border-top:2px dashed #6a923d;padding-top:30px;">
								<div style="float: right;">
									<div id="sect_flow" class="x2Form" style="display:inline-block;">
										<div><label>意见</label><input id="note" style="width:400px;"/></div>
									</div>
									<button id="btn_finish" type="button" class="btn btn-primary">完工</button>
								</div>
							</div>`;//工具条
				}
				
				$("#case").html(html);
				var btnstatus = {// 功能按钮分角色控制
					/*风场长*/  "2": { "experts": "h","eval1": "h", "eval2": "h", "plan": "h", "plansign": "s",  "works": "h", "mats": "h", "devs": "h",  "log": "s", "report": "h", "reportsign": "s", "btn_chatmen": "h",},
					/*驻场*/    "3": { "experts": "h","eval1": "h", "eval2": "h", "plan": "h", "plansign": "s",  "works": "h", "mats": "h", "devs": "h",  "log": "s", "report": "h", "reportsign": "s", "btn_chatmen": "h",},
					/*调度长*/ "11": { "experts": "s","eval1": "h", "eval2": "h", "plan": "s", "plansign": "s",  "works": "s", "mats": "s", "devs": "s",  "log": "h", "report": "h", "reportsign": "h", "btn_chatmen": "s",},
					/*调度*/   "12": { "experts": "h","eval1": "h", "eval2": "h", "plan": "s", "plansign": "h",  "works": "s", "mats": "s", "devs": "s",  "log": "h", "report": "h", "reportsign": "h", "btn_chatmen": "s",},
					/*专家*/   "14": { "experts": "h","eval1": "s", "eval2": "s", "plan": "h", "plansign": "h",  "works": "h", "mats": "h", "devs": "h",  "log": "h", "report": "h", "reportsign": "h", "btn_chatmen": "h",},
					/*队长*/   "16": { "experts": "h","eval1": "h", "eval2": "h", "plan": "h", "plansign": "h",  "works": "s", "mats": "h", "devs": "h",  "log": "s", "report": "s", "reportsign": "h", "btn_chatmen": "h",},
					/*技工*/   "17": { "experts": "h","eval1": "h", "eval2": "h", "plan": "h", "plansign": "h",  "works": "h", "mats": "h", "devs": "h",  "log": "s", "report": "h", "reportsign": "h", "btn_chatmen": "h",},
				};
				$.each(btnstatus[g_user.job], (k, v) => { v == "s" ? $("#btn_"+k).show() : $("#btn_"+k).hide() });
				
				$("#chatman").html(g_focus.chatmen.map(x=>rd_brief(x)).join(""));
				$("#speechlist").html(g_focus.speechlist.map(x=>rd_speech(x)).join(""));
			}
		});
    }

	function onclickButton(node){
		var id = node.attr("id");
		if ( id == "btn_modify" ){
            var dlg = new cbFormDlg();
            dlg.title = "报修单";
            dlg.css = "width:610px";
            dlg.Add(RenderForm4(g_focus.fault, g_faults.fields, f2s));
            dlg.Add(xrimagelistlive2("image", g_focus.fault.imgs.map(x=>x.name)));
			dlg.urlremove = "/case/faultremove?id=" + g_focus.fault.id;
			dlg.urlsubmit = "/case/faultmodify?id="+g_focus.fault.id;
			dlg.closing = function (reason){
				if ( reason == "remove"){
					g_focus = undefined;
					g_faults = undefined;
					checkchange();
				}
				else if (reason == "submit"){
					RenderCase(g_focus.fault.id)
					checkchange();
				}
			}
			dlg.Show();
		}
		else if ( isInArray(["btn_submit","btn_recall","btn_accept","btn_decline","btn_finish"],id )){
			chgstatus(id);
		}
		else if ( id == "btn_experts" ){
			ud_userdlg(["专家"], "", g_focus.experts, function(ar){
				if (ar.length == 0){
					alert("至少选一个专家");
					return;
				}
				var fd = new FormData();
				fd.append("id", g_focus.fault.id);
				fd.append("expert", ar);
				postform("/case/setexpert", fd, "", function (res) {RenderCase(g_focus.fault.id);});
				return true;
			});
		}
		else if ( id == "btn_plansign" || id == "btn_reportsign" ){
			var fd = new FormData();
			fd.append("id", g_focus.fault.id);
			fd.append("type", id);
			postform("/case/sign", fd, "", function (res) {RenderCase(g_focus.fault.id);});
		}
		else if ( id == "btn_works" ){
			if (g_user.job ==11 || g_user.job ==12 ) {// 调度或调度长，指定队长
				ud_userdlg(["维修人员"],"队长",g_focus.engineers, function(ar){
					if (ar.length != 1){
						alert("要求有且仅有一个队长");
						return;
					}
					else if ( g_focus.engineers.length > 0 ){
						if ( !confirm("更换队长将更换整个施工队，要继续吗？"))
							return;
					}
					var fd = new FormData();
					fd.append("id", g_focus.fault.id);
					fd.append("leader", ar[0]);
					postform("/case/setteam", fd, "", function (res) {RenderCase(g_focus.fault.id);});
					return true;
				});
			}
			else if (g_user.job ==16 ) {// 队长，添加队员
				ud_userdlg(["维修队"],g_user.id,g_focus.engineers, function(ar){
					var fd = new FormData();
					fd.append("id", g_focus.fault.id);
					fd.append("leader", g_user.id);
					fd.append("engineers", ar);
					postform("/case/setteam", fd, "", function (res) {RenderCase(g_focus.fault.id);});
					return true;
				});
			}
		}
		else if ( id == "btn_mats" ){
			onclickmats();
		}
		else if ( id == "btn_devs" ){
			onclickfaultdevs();
		}
		else if ( id == "btn_log" ){
			var fields = [
				{ "title": "发表人", "name": "user_id", "forder": "5", "ftype": "div" },
				{ "title": "发表时间", "name": "date", "forder": "5", "ftype": "div" },
				{ "title": "说明", "name": "remark", "forder": "5", "ftype": "input_long" },
			];
            var data = Create(fields);
			data.date = (new Date()).format("yyyy-MM-dd hh:mm:ss");

            var dlg = new cbFormDlg();
            dlg.title = "现场记录";
            dlg.css = "width:610px";
            dlg.Add(RenderForm4(data, fields, function(u, f) {
				var f = (typeof f == "string"?f:f.name);
				if (f == "user_id") return g_user.name;
				return u[f];
			}));
            dlg.Add(xrimagelistlive2("image",[""]));
			dlg.urlsubmit = "/case/addlog?id="+g_focus.fault.id;
			dlg.Show();
		}
		else if ( id == "btn_chatmen" ){
			var expert_ids = g_focus.experts.map(x=>x.id);
			var engineer_ids = g_focus.engineers.map(x=>x.id);
			var chatmen = g_focus.chatmen.filter(x=> {
				if ( x.job==11|| x.id==g_focus.fault.guide_id )// 调度长和接单调度
					return false;
				if((x.job=="2" ||x.job=="3" ) && x.depart_id == g_focus.fault.winder_id)// 风场长和驻场
					return false;
				if( isInArray( expert_ids, x.id) || isInArray( engineer_ids, x.id))// 施工队
					return false;
				return true;
			});
			ud_chats = chatmen;
			ud_userdlg(["当前","调度人员","专家","维修队","维修人员"],"",g_focus.chatmen, function(ar){
		        var fd = new FormData();
				fd.append("id", g_focus.fault.id);
				if ( $("#rolelist span").html() == "当前")
					fd.append("reset", ar);
				else
					fd.append("append", ar);
				postform("/case/setchatmen", fd, "", function (res) {RenderCase(g_focus.fault.id);});
				return true;
			});
		}
	}

    function chgstatus(action) {
        var fd = new FormData();
        fd.append("id", g_focus.fault.id);
        fd.append("action", action);
        fd.append("status", g_focus.fault.status);
		fd.append("maxid", g_focus.maxid);
		var note =$("#note");
		if (note.length != 0 )
			fd.append("note", note[0].value);
		else
			fd.append("note", "");
        postform("/case/chgstatus", fd, "", function (res) {
            if (res.result == "200") {
				checkchange();
				RenderCase(g_focus.fault.id);
                alert("操作成功！");
            }
			else if (res.result == "405") {
				checkchange();
				RenderCase(g_focus.fault.id);
			}
        });
    }

	function f2s(u,f){
		var f = (typeof f == "string"?f:f.name);
		if (f=="devices"){
			var h = "";
			if ( u.efans.length >0 )
					h+="风机："+u.efans.map(x=>x.code).join(",");
			if ( u.leafs.length >0 )
					h+="叶片："+u.leafs.map(x=>x.code).join(",");
			return h;
		}
		else if ( f == "report_id") return u["report_name"];
		else if ( f == "winder_id") return u["winder_name"];
		return u[f];
	}
	function f2s_mat(u,f){
		var f = (typeof f == "string"?f:f.name);
		var val = u.chg != undefined  && u.chg[f] != undefined ? u.chg[f]:u[f];

		var mat = GetSub(g_mats.data, "id", u.chg != undefined  && u.chg.mat_id != undefined ? u.chg.mat_id:u.mat_id);
		if ( f == "mat_id") return mat.name+"("+mat.type+")";
		else if ( f == "num") return val+mat.unit;
		else if ( f == "matwh_id") return GetSub(g_matwhs.data, "id", val).name;
		else if ( f == "status") return fault_matstatus[val];
		return val;
	}
	function f2s_dev(u,f){
		var f = (typeof f == "string"?f:f.name);
		if (f=="devices"){
			var h = "";
			if ( u.efans.length >0 )
					h+="风机："+u.efans.map(x=>x.code).join(",");
			if ( u.leafs.length >0 )
					h+="叶片："+u.leafs.map(x=>x.code).join(",");
			return h;
		}
		else if ( f == "report_id") return u["report_name"];
		else if ( f == "winder_id") return u["winder_name"];
		return u[f];
	}
</script>

<script type="text/javascript">
var g_devwhs, g_focus_devwork;
function onclickfaultdevs(){
	if (g_devwhs == undefined)
		Reqdata("/rd?ls=devwh", "", function (res) {g_devwhs = res;});

	var dlg = new devdlg(g_focus.fault);
	dlg.Show();
}

//对话框组件
function devdlg(fault) {
    this.id = "devdlg" + Math.ceil(Math.random() * 1000000).toString();
	this.fault=fault;
}

devdlg.prototype.Show = function () {
    var html = '<div class="modal fade" id="' + this.id + '" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true" data-backdrop="false">'
        + '<div class="modal-dialog" style="width:900px">'
        + '<div class="modal-content">'
		+ `    <div class="xFCsrow" >	
				   <div class="modal-header" style="width:100px;">
					   <h4 class="modal-title" id="ModalDlgTitle">调用设备</h4>
				  </div>
				  <div class="xFIfixed radio_group" style="padding-top:30px;">
				      <div class="active">查看任务</div><div>查看位置</div>
				  </div>
				  <div class="modal-header" style="width:100px;" >
					   <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
				  </div>
              </div>
			  <div class="modal-body" style="padding:5px;height:450px;"></div>
			  <div class="modal-footer">
            </div>
        </div><!-- /.modal-content -->
        </div><!-- /.modal -->`;
    $("body").append(html);
    $('#' + this.id).on('hide.bs.modal', "", { This: this }, function (ev) {ev.data.This.closedlg(); });
    $('#' + this.id).modal('show');
    $('#' + this.id+" .radio_group").on("click", '', { This: this }, function (ev) {ev.data.This.onRadioGroup(ev);});
	g_focus_devwork=undefined;
	this.refresh();
}
devdlg.prototype.closedlg = function () {
    $('#' + this.id).remove();
}

devdlg.prototype.onRadioGroup = function (ev) {
	$(ev.target).addClass("active");
	$(ev.target).siblings().removeClass("active");
	if (ev.target.innerText=="查看任务"){
		this.refresh();
	}
	else{
	
	}
}

devdlg.prototype.onclickCard = function (ev) {
    $("#"+ this.id + " .fault_card ").removeClass("fault_card_focus");
    $(ev.delegateTarget).addClass("fault_card_focus");

	var id = $(ev.delegateTarget).attr("data_id");
	g_focus_devwork = GetSub(this.devworks.data, "id", id);
	this.refreshdetail();
}

devdlg.prototype.onclickButton = function (ev) {
	if ( ev.target.innerText == "新建" ){
		g_focus_devwork = Create( this.devworks.fields);
		g_focus_devwork.fault_id = g_focus.fault.id;
		g_focus_devwork.detail = new Object();
		g_focus_devwork.detail.fault = g_focus.fault;
		g_focus_devwork.guide_id = g_user.id;
		g_focus_devwork.detail.users = [g_user];
		g_focus_devwork.guidedt = (new Date()).format("yyyy-MM-dd hh:mm:ss.S")
		g_focus_devwork.winder_id = g_focus.fault.winder_id;
		g_focus_devwork.detail.winder={"id":g_focus.fault.winder_id, "name":g_focus.fault.winder_name, "addr":""};
	
		this.justifyfields();
		$('#' + this.id+" form").html(RenderFormIn(g_focus_devwork, this.devworks.fields, f2eDevwork));
		this.refreshbtnary();
	}
	else if ( ev.target.innerText == "删除" ){
		if ( !confirm("确定要删除？"))
			return;
		if ( g_focus_devwork.id == ""){
			g_focus_devwork = undefined;
			this.refresh();
		}
		else {
			Reqdata("/dev/devworkremove?id="+g_focus_devwork.id, this, function (res,ctx) {
				if (res.result==200){
					g_focus_devwork = undefined;
					ctx.refresh();
				}
			});
		}
	}
	else if ( ev.target.innerText == "保存" ){
		var fd = new FormData($('#' + this.id+" form")[0]);
		if ( g_focus_devwork.id == ""){
			postform("/dev/devworkcreate", fd, this, function (res,ctx) {
				if (res.result==200){
					g_focus_devwork.id=res.data.id;
					ctx.refresh();
				}
			});
		}
		else {
			postform("/dev/devworkmodify?id="+g_focus_devwork.id, fd, this, function (res,ctx) {
				if (res.result==200)
					ctx.refresh();
			});
		}
	}
	else {
		this.chgstatus(ev.target.innerText);
	}
}

devdlg.prototype.chgstatus = function(text){
	if (-1==!$.inArray(text, ["提交","撤回","接单","退回","确认到达","任务结束"])){
		alert("不认识的操作类型");
		return;
	}

    var fd = new FormData();
    fd.append("id", g_focus_devwork.id);
    fd.append("action", text);
    fd.append("status", g_focus_devwork.status);
	fd.append("maxid", g_focus_devwork.detail.statuslist[0].id);
    postform("/dev/devworkchgstatus", fd, this, function (res,ctx) {
        if (res.result == "200") {
			ctx.refresh();
            alert("操作成功！");
        }
    });
}

devdlg.prototype.refresh = function() {
	Reqdata("/dev/devworkquery?fault_id="+this.fault.id, this, function (res, ctx) {
		var tpl=`<div class="xFCsrow" style="height:100%;">
				<section class="xPanel2 xFIfixed" style="width: 240px;">
					<header>调用单列表<div style="float: right;"><a>新建</a></div></header>
					<div id="fault_cards" style="overflow-y: auto;">{0}</div>
				</section>
				<div style="padding:10px 15px;">
					<form class="x2Form" style="height:360px;"></form>
					<div class="btnarray" style="padding:20px 50px 0px 15px;"></div>
				</div>
			</div>`;
		ctx.devworks=res;
		res.fields.insertaftername( "winder_id", { title: "风场地址", name: "winder_addr", ftype:"div", twidth: "120" } );
		var ttt = tpl.format(res.data.map(dw=>rdcard_devwork(dw)).join(""));
		$('#' + ctx.id+" .modal-body").html(tpl.format(res.data.map(dw=>rdcard_devwork(dw)).join("")));
		$("#fault_cards .fault_card").on('click', "", { This: ctx }, function (ev) {ev.data.This.onclickCard(ev); });
		$("#"+ctx.id+" header a").on('click', "", { This: ctx }, function (ev) {ev.data.This.onclickButton(ev); });
		if ( g_focus_devwork != undefined ){
			ctx.refreshdetail();
			$("#"+ctx.id+" [data_id="+g_focus_devwork.id+"]").addClass("fault_card_focus");
		}
		else
			ctx.refreshbtnary();
	});
}

devdlg.prototype.refreshdetail = function () {
	Reqdata("/dev/devworkdetail?id="+g_focus_devwork.id, this, function (res, ctx) {
		g_focus_devwork = res.devwork;
		g_focus_devwork.detail = res;
		ctx.justifyfields();
		$('#' + ctx.id+" form").html(RenderFormIn(g_focus_devwork, ctx.devworks.fields, f2eDevwork));
		ctx.refreshbtnary();
	});
}

devdlg.prototype.refreshbtnary = function () {
	var btnary="";
	$("#"+this.id+" header a").hide();
	if ( g_focus_devwork==undefined)
		return;
	if (g_user.job == 11 || g_user.job == 12){// 调度长或调度
		if ( g_focus_devwork.status == 0 || g_focus_devwork.status == -1 ){
			btnary=`<button id="btndw_delete" type="button" class="btn btn-default" style="color:#aaaaaa">删除</button>
				<div style="float: right;">
					<button id="btndw_save" type="button" class="btn btn-primary">保存</button>
					<button id="btndw_submit" type="button" class="btn btn-primary">提交</button>
				</div>`;
		}
		else if ( g_focus_devwork.status == 1 ){
			btnary=`<button id="btndw_recall" type="button" class="btn btn-default" style="color:#aaaaaa">撤回</button>`;
		}
		$("#"+this.id+" header a").show();
	}
	else if (g_user.job == 5 ){// 驻地长
		btnary=`<div style="float: right;">
				<button id="btndw_accept" type="button" class="btn btn-primary">接单</button>
				<button id="btndw_decline" type="button" class="btn btn-primary">退回</button>
			</div>`
	}
	else if (g_user.job == 5 ){// 风场长和驻场
		if ( g_focus_devwork.status == 2 ){
			btnary=`<div style="float: right;">
					<button id="btndw_decline" type="button" class="btn btn-primary">确认到达</button>
				</div>`
		}
		else if ( g_focus_devwork.status == 3 ){
			btnary=`<div style="float: right;">
					<button id="btndw_decline" type="button" class="btn btn-primary">任务结束</button>
				</div>`
		}
	}

	$('#' + this.id+" .btnarray").html(btnary);
	$('#' + this.id+" .btnarray button").on('click', "", { This: this }, function (ev) {ev.data.This.onclickButton(ev); });
}

devdlg.prototype.justifyfields = function () {
	if (g_focus_devwork.status == -1){
		GetSub( this.devworks.fields, "name", "deal_id").ftype="div";
		GetSub( this.devworks.fields, "name", "dealdt").ftype="div";
		GetSub( this.devworks.fields, "name", "dev_id").ftype="none";
		GetSub( this.devworks.fields, "name", "driver_id").ftype="none";
	}
	else if (g_focus_devwork.status == 0 || g_focus_devwork.status == 1 ){
		GetSub( this.devworks.fields, "name", "deal_id").ftype="none";
		GetSub( this.devworks.fields, "name", "dealdt").ftype="none";
		GetSub( this.devworks.fields, "name", "dev_id").ftype="none";
		GetSub( this.devworks.fields, "name", "driver_id").ftype="none";
	}
	else {
		GetSub( this.devworks.fields, "name", "deal_id").ftype="div";
		GetSub( this.devworks.fields, "name", "dealdt").ftype="div";
		GetSub( this.devworks.fields, "name", "dev_id").ftype="div";
		GetSub( this.devworks.fields, "name", "driver_id").ftype="div";
	}

	// 调度长或调度可编辑
	if ( (g_user.job == 11 || g_user.job == 12) && (g_focus_devwork.status == -1 || g_focus_devwork.status == 0) ){
		GetSub( this.devworks.fields, "name", "clss").ftype="select";
		GetSub( this.devworks.fields, "name", "type").ftype="input";
		GetSub( this.devworks.fields, "name", "devwh_id").ftype="select";
		GetSub( this.devworks.fields, "name", "timelen").ftype="input";
		GetSub( this.devworks.fields, "name", "remark").ftype="input_long";
	}
	else{ // 所有字段仅只读
		GetSub( this.devworks.fields, "name", "clss").ftype="div";
		GetSub( this.devworks.fields, "name", "type").ftype="div";
		GetSub( this.devworks.fields, "name", "devwh_id").ftype="div";
		GetSub( this.devworks.fields, "name", "timelen").ftype="div";
		GetSub( this.devworks.fields, "name", "remark").ftype="div_long";
	}

	if (g_user.job == 5 && g_focus_devwork == 1 ){// 驻地长
		GetSub( this.devworks.fields, "name", "dev_id").ftype="select";
		GetSub( this.devworks.fields, "name", "driver_id").ftype="select";
	}
}

function f2eDevwork(u,fd) {
	function rd_status(status, items, users ) {
		`<div class="xCombox">
			<span>{text}</span>
			<div class="xPopWnd xdoclist">{items}</div>
		</div>`

		// 只需要内部的东西
		return `<span>{text}</span><div class="xPopWnd xdoclist">{items}</div>`.format({
			"text":GetSub(status, "id",u[f]).name, 
			"items":items.map(x=>"<div>"+x.id+" "+ x.date.substr(5,11)+ " " 
				+ GetSub(users, "id", x.user_id ).name + " "+ x.remark + "</div>" ).join("")
		});
	}

	var f = (typeof fd == "string"?fd:fd.name);
	if ( f == "status"){ 
		if ( u[f]=="") return "新建";
		return rd_status(status_devwork, g_focus_devwork.detail.statuslist, g_focus_devwork.detail.users );
	}
	else if ( f=="guide_id") return u[f]==""?"":GetSub(g_focus_devwork.detail.users, "id", u[f]).name;
	else if ( f=="guidedt") return u[f]==""?"":u[f].substr(5,11);
	else if ( f=="fault_id") return u[f]==""?"":g_focus_devwork.detail.fault.code;
	else if ( f=="timelen")	return u[f]==""?"":u[f]+"天";
	else if ( f=="winder_id")	return u[f]==""?"":g_focus_devwork.detail.winder.name;
	else if ( f=="winder_addr")	return u["winder_id"]==""?"":g_focus_devwork.detail.winder.addr;
	else if ( f=="deal_id")	return u[f]==""?"":GetSub(g_focus_devwork.detail.users, "id", u[f]).name;
	else if ( f=="dealdt")	return u[f]==""?"":u[f].substr(5,11);
	else if ( f=="clss"){
		if ( fd.ftype=="select")
			return RenderSelect(db_devclss, u[f]);
		else
			return u[f]==""?"":GetSub(db_devclss, "id", u[f]).name;
	}
	else if ( f == "devwh_id"){
		if ( fd.ftype=="select")
			return RenderSelect(g_devwhs.data, u[f]);
		else
			return u[f]==""?"":GetSub(g_devwhs.data, "id", u[f]).name;
		return fault_matstatus[val];
	}
	else if ( f=="dev_id"){
//		if ( fd.ftype=="select")
//			return RenderSelect(this.devs, u[f]);
//		else
			return u[f]==""?"":g_focus_devwork.detail.dev.code;
	}
	else if ( f=="driver_id"){
//		if ( fd.ftype=="select")
//			return RenderSelect(this.drivers, u[f]);
//		else
		return u[f]==""?"":GetSub(g_focus_devwork.detail.users, "id", u[f]).name;
	}

	return u[f];
}

function rdcard_devwork(dw){
	var tpl1 = `<div class="fault_card" data_id="{id}">
			<div class="header">
				<div class="type">调用单</div>
				<div class="title">{clss}</div>
			</div>
			<div class="body" style="text-align:left;">
				<div><strong>型号：</strong>{type}</div>
				<div><strong>所属驻地：</strong>{devwh_id}</div>
			</div>
		</div>`;

	var tpl2 = `<div class="fault_card" data_id="{id}">
			<div class="header">
				<div class="type">调用单</div>
				<div class="title">{clss}</div>
			</div>
			<div class="body" style="text-align:left;">
				<div><strong>型号：</strong>{type}</div>
				<div><strong>所属驻地：</strong>{devwh_id}</div>
				<div><strong>调用设备：</strong>{dev_id}</div>
				<div><strong>司机：</strong>{driver_id}</div>
			</div>
		</div>`;
	
	function toshow(obj){
		var r=new Object();
		for ( var x in obj){
			if (x == "clss") r[x] = GetSub(db_devclss, "id", obj[x]).name;
			else if (x == "devwh_id") r[x] = obj[x]=="" ? "":GetSub(g_devwhs.data, "id", obj[x]).name;
			else if (x == "dev_id") r[x] = obj["dev_code"];
			else if (x == "driver_id") r[x] = obj["driver_name"];
			else r[x]=obj[x];
		}
		return r;
	}
	return dw.status >= 2 ? tpl2.format(toshow(dw)):tpl1.format(toshow(dw));
}


</script>
</body>
</html>

