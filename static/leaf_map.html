<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
    <script type="text/javascript" src="http://api.map.baidu.com/api?v=3.0&ak=nSxiPohfziUaCuONe4ViUP2N"></script>
    <script src="js/jquery.js"></script>
    <script src="js/bootstrap.js"></script>
    <link rel="stylesheet" href="css/bootstrap.css" />
    <link rel="stylesheet" href="css/xpecker.css" />
    <script src="js/xpecker.js"></script>
    <script src="js/db.js"></script> <!--用到branch-->
    <title></title>
    <style>

    </style>
</head>
<body onbeforeunload="UpdateCurData()">
    <div id="allmap" style="height: 100%;width: 100%;"></div>
</body>
</html>
<script type="text/javascript">
    // 百度地图API功能
    var map = new BMap.Map("allmap");
    map.centerAndZoom(new BMap.Point(116.404, 39.915), 6); //设置中心点坐标和地图级别
    map.addControl(new BMap.ScaleControl({ anchor: BMAP_ANCHOR_BOTTOM_RIGHT })); // 左下角，添加比例尺
    map.addControl(new BMap.NavigationControl({ anchor: BMAP_ANCHOR_TOP_RIGHT })); //左上角，添加默认缩放平移控件
    map.enableScrollWheelZoom();//开启鼠标滚轮缩放

    var winders = new Object();
    var winderareas = new Object();
    var efans = new Object();

    function UpdateCurData(type, data) {
        if (curdata)
        {
            if (curdata.type == "winder") {

            }
            else if (curdata.type == "winderarea") {

            }
            else if (curdata.type == "efan") {

            }
            alert("save " + curdata.type);
        }
        curdata = new Object();
        curdata.type = type;
        curdata.data = data;
    }

    // 在地图上显示风场
    Request("/query?type=winder", function (d1) {
        var flower = new BMap.Icon("img/diy/3.png", new BMap.Size(16, 16));
        var efan_icon = new BMap.Icon("img/efan.png", new BMap.Size(16, 16));
        winders = d1;
        for (var x in d1.data) {
            var marker = new BMap.Marker(CreatePoint(d1.data[x].position), { icon: flower });
            var label = new BMap.Label(d1.data[x].name, { offset: new BMap.Size(20, -1) });
            label.setStyle({ border: "0px", color: "blue" });
            marker.setLabel(label);
            map.addOverlay(marker);
            d1.data[x].mk = marker;
            BindWinderEvent(marker, label, d1.data, x);
        }
    });
    function BindWinderEvent(mk,lbl,ar,idx) {
        mk.addEventListener("dragend", function (type, target, pixel, point) {
            UpdateCurData("winder", ar[idx]);
        });
        mk.addEventListener("click", function (e) { ShowInfoWindow(ar, idx, e); });
        lbl.addEventListener("click", function (e) { ShowInfoWindow(ar, idx, e); });
    }

    // 在地图上显示风区
    Request("/query?type=winderarea", function (d2) {
        winderareas = d2;
        for (var x in winderareas.data) {
            var plg = CreatePolygon(winderareas.data[x].position);
            winderareas.data[x].plg = plg;
            map.addOverlay(plg);

            var label = CreateAreaLabel(winderareas.data[x]);
            winderareas.data[x].lbl = label;
            map.addOverlay(label);

            BindAreaEvent(winderareas.data[x]);
        }
    });
    // 计算中心点位置
    function CalCenter(path) {
        var lng = 0, lat = 0;
        for (var i in path) {
            lng += path[i].lng;
            lat += path[i].lat;
        }
        return new BMap.Point(lng / path.length, lat / path.length);
    }
    function CreateAreaLabel(area) {
        var opts = {
            position: CalCenter(area.plg.getPath()),
            offset: new BMap.Size(-6 * area.name.length, -6)    //设置文本偏移量
        }
        var label = new BMap.Label(area.name, opts);  // 创建文本标注对象
        label.setStyle({
            border: "0px",
            color: "Chocolate",
            fontSize: "12px",
            height: "20px",
            lineHeight: "20px",
            fontFamily: "微软雅黑"
        });
        map.addOverlay(label);   
        return label;
    }
    function BindAreaEvent(area) {
        area.plg.addEventListener("click", function (type, target, point, pixel) {
            // 显示本风区的风电机
            Request("/query?type=efan&winderarea_id=" + area.id, function (d2) {
                efans = d2;
                for (var x in d2.data) {
                    var marker = new BMap.Marker(CreatePoint(d2.data[x].position), { icon: efan_icon });
                    var label = new BMap.Label(d2.data[x].code, { offset: new BMap.Size(20, -1) });
                    label.setStyle({ border: "0px", color: "Chocolate" });
                    marker.setLabel(label);
                    map.addOverlay(marker);
                    d2.data[x].mk = marker;
                    BindEfanEvent(marker, label, d2.data, x);
                }
            });
            // 更新当前对象为自己
            UpdateCurData("winderarea", area);
        });
        area.plg.addEventListener("lineupdate", function (type, target) {
            area.plg.lbl.setPosition(CalCenter(area.plg.getPath()));
        });
    }
    function BindEfanEvent(mk, lbl, ar, idx) {
        mk.addEventListener("dragend", function (type, target, pixel, point) {
            UpdateCurData("efan", ar[idx]);
        });
        mk.addEventListener("click", function (e) { ShowEfanWindow(ar, idx, e); });
        lbl.addEventListener("click", function (e) { ShowEfanWindow(ar, idx, e); });
    }
    function ShowEfanWindow(ar, i, e) {
        // ...

        //var p = e.target;
        //var point = new BMap.Point(p.getPosition().lng, p.getPosition().lat);
        //var content = '<div class="xRndAngle x2Form" style="overflow-y: scroll;height:290px;padding:5px 0px">' + RenderPane(ar, i) + '</div>';
        //var infoWindow = new BMap.InfoWindow(content, {
        //    width: 619,     // 信息窗口宽度
        //    height: 320,     // 信息窗口高度
        //    title: "风场信息", // 信息窗口标题
        //    enableMessage: true//设置允许信息窗发送短息
        //});  // 创建信息窗口对象 
        //map.openInfoWindow(infoWindow, point); //开启信息窗口
        //ID2Name(ar, i);
    }

    //-----------------OrganTreeControl begin------------------------------------------------
    // 定义组织机构控件,即function
    function OrganTreeControl() {
        // 默认停靠位置和偏移量
        this.defaultAnchor = BMAP_ANCHOR_TOP_LEFT;
        this.defaultOffset = new BMap.Size(10, 10);
    }
    // 通过JavaScript的prototype属性继承于BMap.Control
    OrganTreeControl.prototype = new BMap.Control();
    // 自定义控件必须实现自己的initialize方法,并且将控件的DOM元素返回
    // 在本方法中创建个div元素作为控件的容器,并将其添加到地图容器中
    OrganTreeControl.prototype.initialize = function (map) {
        // 创建一个DOM元素
        var div = document.createElement("div");
        div.innerHTML = '<div class="xRndAngle" style="width:250px;padding:5px 10px;"><span id="selitem">选中的项</span><div style="float: right;" onclick="clickcollapse(this)">收起</div></div><div id="root" class="xTree xScroll" style="width:250px;height:800px;padding:5px 10px;border:1px solid lavender;"></div>';
        div.style.backgroundColor = "white";
        div.style.boxShadow = "1px 1px 1px rgba(0,0,0,.1)";

        // 这两行是解决在树上滚轮动作时，地图动而树不滚动的问题
        $(div).on("mouseover", function () { map.disableScrollWheelZoom(); });//关闭鼠标滚轮缩放
        $(div).on("mouseout", function () { map.enableScrollWheelZoom(); });//开启鼠标滚轮缩放

        request2("root");

        // 添加DOM元素到地图中
        map.getContainer().appendChild(div);
        // 将DOM元素返回
        return div;
    }
    // 创建控件
    var organtree = new OrganTreeControl();
    // 添加到地图当中
    map.addControl(organtree);
    //-----------------OrganTreeControl end------------------------------------------------

    //-----------------ModeControl begin------------------------------------------------
    // 定义模式控件,即function
    function ModeControl() {
        // 默认停靠位置和偏移量
        this.defaultAnchor = BMAP_ANCHOR_TOP_LEFT;
        this.defaultOffset = new BMap.Size(270, 10);
    }
    // 通过JavaScript的prototype属性继承于BMap.Control
    ModeControl.prototype = new BMap.Control();
    // 自定义控件必须实现自己的initialize方法,并且将控件的DOM元素返回
    // 在本方法中创建个div元素作为控件的容器,并将其添加到地图容器中
    ModeControl.prototype.initialize = function (map) {
        // 创建一个DOM元素
        var div = document.createElement("div");
        div.innerHTML = '浏览';
        div.style.backgroundColor = "white";
        div.style.border = "1px solid lavender";
        div.style.boxShadow = "1px 1px 1px rgba(0,0,0,.1)";
        div.style.padding = "5px 10px";
        $(div).addClass( "xRndAngle" );
        $(div).on("click", function () {
            editmode = !editmode;
            if (editmode) {
                div.innerHTML = '编辑';
                for (var i in winders.data)
                    winders.data[i].mk.enableDragging();
            }
            else {
                div.innerHTML = '浏览';
                for (var i in winders.data)
                    winders.data[i].mk.disableDragging();
            }
        });

        // 添加DOM元素到地图中
        map.getContainer().appendChild(div);
        // 将DOM元素返回
        return div;
    }
    // 创建控件
    var modectrl = new ModeControl();
    // 添加到地图当中
    map.addControl(modectrl);
    // -----------------ModeControl end---------------------------

    function CreatePoint( pos ) {
        var ar = pos.split(" ");
        return new BMap.Point(parseFloat(ar[0]), parseFloat(ar[1]));
    }

    function CreatePolygon( pos ) {
        var ar = pos.split(",");
        var arr = [];
        for (var i in ar)
            arr.push(CreatePoint(ar[i]));
        return new BMap.Polygon(arr, { strokeColor: "Chocolate", strokeWeight: 2, strokeOpacity: 0.5 });
    }

    function addClickHandler(id, marker) {
        marker.addEventListener("click", function (e) {
            Request("/itemdetail?type=winder&id=" + id, function (d1) { openInfo(d1, e); });
        });
    }
    function ShowInfoWindow(ar,i,e) {
        var p = e.target;
        var point = new BMap.Point(p.getPosition().lng, p.getPosition().lat);
        var content = '<div class="xRndAngle x2Form" style="overflow-y: scroll;height:290px;padding:5px 0px">' + RenderPane(ar, i) + '</div>';
        var infoWindow = new BMap.InfoWindow(content, {
            width: 619,     // 信息窗口宽度
            height: 320,     // 信息窗口高度
            title: "风场信息", // 信息窗口标题
            enableMessage: true//设置允许信息窗发送短息
        });  // 创建信息窗口对象 
        map.openInfoWindow(infoWindow, point); //开启信息窗口
        ID2Name(ar, i);
    }

    // 给出文档节点ID，展开下级列表 id格式：root或winderco_1
    function request2(id) {
        var at = id.split("_");
        var type = branch.sub(at[0]).type;
        if (type == "winderco" || type == "winderprov") {
            Request("/query?type=" + type + (at[1] ? "&" + at[0] + "_id=" + at[1] : ""),
                function (res) {TreeAddChildren(id, res.data);});
        }
        else if (type == "winder") { TreeAddChildren(id, winders.data); }
        else if (type == "winderarea") { TreeAddChildren(id, winderareas.data); }
    }

    function TreeAddChildren(id, data) {
        var at = id.split("_");
        var type = branch.sub(at[0]).type;

        var html = "";
        for (var i in data) {
            if (data[i][at[0] + "_id"] != at[1])
                continue;
            if (type != "winderarea") {
                html += "<div id=\"" + type + "_" + data[i].id + "\">"
                    + "<img src=\"img/nolines_plus.gif\"><span><img src=\""
                    + branch[type].image + "\">" + data[i].name + "</span></div>\n"
            }
            else { // 少了左边的加号，为缩进对齐加了一层div
                html += "<div><div id=\"" + type + "_" + data[i].id + "\"><span><img src=\""
                    + branch[type].image + "\">" + data[i].name + "</span></div></div>\n"
            }
        }

        $("#" + id).append(html);
        $("#" + id).children("img").attr("src", "img/nolines_minus.gif");

        $(".xTree div>img").unbind("click", itemexpand);
        $(".xTree div>span").unbind("click", itemclick);
        $(".xTree div>img").bind("click", itemexpand);
        $(".xTree div>span").bind("click", itemclick);
    }

    function itemexpand() {
        var siblings = $(this).siblings("div");
        if (siblings.length == 0) {
            var id = $(this).parent().attr("id");
            request2(id);
        }
        else if (siblings.css("display") == "none") {
            $(event.srcElement).attr("src", "img/nolines_minus.gif");
            siblings.css("display", "block");
        }
        else {
            $(event.srcElement).attr("src", "img/nolines_plus.gif");
            siblings.css("display", "none");
        }
    }
    //点击树节点
    function itemclick() {
        var at = $(this).parent().attr("id").split("_");
        $("#selitem").html($(this).html());
        if (at[0] == "winder") {
            mk = FindSub(winders.data, at[1]).mk;
            mk.setAnimation(BMAP_ANIMATION_BOUNCE);
            map.centerAndZoom(mk.getPosition(), 6); //设置中心点坐标和地图级别
        }
        else if (at[0] == "winderarea") {
            // 开始编辑
        }
    }

    function clickcollapse() {
        if ($("#root").css("display") == "none") {
            $("#root").css("display", "block");
            $(this).html("收起");
        }
        else {
            $("#root").css("display", "none");
            $(this).html("展开");
        }
    }

</script>
