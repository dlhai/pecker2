<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>啄木鸟风电维保系统</title>
    <script src="js/jquery.js"></script>
    <link rel="stylesheet" href="css/bootstrap.css"/>
    <script src="js/bootstrap.js"></script>
    <script type="text/javascript" src="js/doTe.js"></script>
    <script src="js/utils.js"></script>
    <script src="js/db.js"></script>
    <link rel="stylesheet" href="css/xpecker.css" />
    <script src="js/xpecker.js"></script>
    <link rel="stylesheet" href="css/Cube.css" />
    <script src="js/Cube.js"></script>

    <link rel="StyleSheet" href="css/coord_card.css" type="text/css" />
    <link rel="StyleSheet" href="css/coord_style.css" type="text/css" />

    <style type="text/css">
        .narrow{}
        .narrow>div>div:first-of-type{width: 165px;}
    </style> 
</head>
<body class="xFCsrow">
    <section class="xPanel2 xFIfixed" style="width:300px;">
        <header>任务列表<div style="float: right;"><a href="#">添加</a></div></header>
        <div id="troublelist" class="xScroll" style="height:100px;flex-grow: 1;"></div>
    </section>
    <section class="xPanel2" style="width: 700px; max-width:900px;">
        <header>案件处理</header>
        <div style="height:100px;flex-grow: 1;padding:0px;">
            <details id="fault" open class="xDetail"><summary style="border-top:0px;">报修</summary>
            </details>
            <details open class="xDetail"><summary>准备</summary><div id="prepare"></div></details>
            <details open class="xDetail"><summary>维修<div style="float: right;"><a href="#">添加</a></div></summary><div id="repair_log"></div></details>
            <details open class="xDetail"><summary>完工</summary><div id="complete"></div></details>
        </div>
    </section>
    <section class="xPanel2 xFIfixed" style="width:200px;min-width:160px;">
        <header>参与人员<div style="float: right;"><a href="#">管理</a></div></header>
        <div id="userlist" class="xScroll" style="height:100px;flex-grow: 1;"><div>asdfasldkjf;lasdkjfasjdfjasdlfjlk</div><div>asdfasldkjf;lasdkjfasjdfjasdlfjlk</div><div>asdfasldkjf;lasdkjfasjdfjasdlfjlk</div></div>
    </section>
    <section class="xPanel2" style="width: 450px; min-width: 300px;">
        <header>对话</header>
        <div id="speechlist" class="xScroll" style="height:100px;flex-grow: 1;"></div>
        <footer class="xFCsrow" style="padding:10px; height: 120px; width: 100%; align-items: flex-end;">
            <textarea class="xrAngle" style="margin-right:10px; padding:5px 10px; height:100px;width:100px;resize:none;"></textarea>
            <div class="xFIfixed"><button>发送</button></div>
        </footer>
    </section>

<script type="text/javascript">
    function crd_card(obj) {
        var tpl = `<div class="card" code="{code}">
                <div class="header">
                    <div class="type">报修单</div>
                    <div class="title">{type}</div>
                </div>
                <div class="body" style="text-align:left;">
                    <div><strong>单号：</strong>{code}</div>
                    <div><strong>报修人：</strong>{report_name}</div>
                    <div><strong>联系电话：</strong>{phone}</div>
                    <div><strong>单位：</strong>{winder_name}</div>
                </div>
            </div>`
        return tpl.format(obj);
    }

    function crd_render_fault(obj, fields) {
        var r = '<div class="x2Form narrow">' + RenderPane2(obj, fields) +'</div>';
        var tpl_remark = `<div id="remark" class="xRndAngle" style="margin:10px;margin-top:5px; padding:5px 10px;">{0}</div>`
        r += tpl_remark.format(obj.remark);
        return r;
    }

    

    
</script>

<script type="text/javascript">
    var g_cursel = -1;
    var g_user = parent.g_user, faultlist = [];
    if (g_user == undefined)
        g_user = GetRoleUser("调度");

    Reqdata("/rdfault?guide_id=" + g_user.id, "", function (res) {
        faultlist = res;
        faultlist.fieldsshow = Clone(faultlist.fields);
        GetSub(faultlist.fieldsshow, "name", "report_id").name = "report_name";
        GetSub(faultlist.fieldsshow, "name", "winder_id").name = "winder_name";
        faultlist.fieldsshow.splice(GetIdx(faultlist.fieldsshow, "name", "remark" ),1);
        $("#troublelist").html((faultlist.data.map(x => crd_card(x)).join("")));
        $(".card").click(renderdetail);
    });

    function renderdetail()
    {
        if (g_cursel != -1)
            $(this).parent().children(":nth-child(" + g_cursel + ")").children(".header").css("background", "linear-gradient(to bottom, rgba(192,215,140,1) 0%,rgba(118,170,73,1) 100%)");
        g_cursel = $(this).index()+1;
        $(this).children(".header").css("background", "linear-gradient(to bottom, rgba(233,209,154,1) 0%,rgba(208,157,80,1) 100%)");

        var fault = faultlist.data[g_cursel];
        $("#fault").html(crd_render_fault(fault, faultlist.fieldsshow));
        //Reqdata("/rd?ls=addit&type=faultspot&ref_id=" + fault.id, "", function (res) { renderimagelist() }
        Reqdata("/rd?ls=link&type=f_experts&ref_id=" + fault.id, "", function (res) { renderimagelist() });
        Reqdata("/rd?ls=addit&type=eval1rep&ref_id=" + fault.id, "", function (res) { renderimagelist() });
        Reqdata("/rd?ls=addit&type=eval2rep&ref_id=" + fault.id, "", function (res) { renderimagelist() });
        Reqdata("/rd?ls=addit&type=repairprog&ref_id=" + fault.id, "", function (res) { renderimagelist() });
        //Reqdata("/rd?ls=link&type=conform&ref_id=" + fault.id, "", function (res) { renderimagelist() });
        Reqdata("/rd?ls=link&type=repairteam&ref_id=" + fault.id, "", function (res) { renderimagelist() });
        


        $("#prepare_expert").html(tpl_users(cur.prepare_expert));
        $("#prepare_report").html(tpl_doc(cur.prepare_report));
        $("#prepare_report2").html(tpl_doc(cur.prepare_report2));
        $("#prepare_scheme").html(tpl_scheme(cur.prepare_scheme));
        $("#prepare_windermastersign").html(cur.prepare_windermastersign.who.name);
        $("#prepare_windermastersign").css("background-image","url(img/yin/C_200.png)");
        $("#prepare_winderclerksign").html(cur.prepare_winderclerksign.who.name);
        $("#prepare_winderclerksign").css("background-image", "url(img/yin/C_47.png)");
        $("#prepare_coordmastersign").html(cur.prepare_coordmastersign.who.name);
        $("#prepare_coordmastersign").css("background-image", "url(img/yin/C_123.png)");

        $("#repair_team").html(tpl_users(cur.repair_team));
        $("#repair_mat").html(tpl_nails(cur.repair_mat));
        $("#repair_dev").html(tpl_nails(cur.repair_dev));
        $("#repair_log").html(tpl_repair_log(cur.repair_log));

        $("#complete_report").html(tpl_repairreport(cur.complete_report));
        $("#complete_winderclerksign").html(cur.complete_winderclerksign.who.name);
        $("#complete_winderclerksign").css("background-image", "url(img/yin/C_47.png)");
        $("#complete_repairteamldrsign").html(cur.complete_repairteamldrsign.who.name);
        $("#complete_repairteamldrsign").css("background-image", "url(img/yin/C_98.png)");
        $("#userlist").html(tpl_userlist(cur.userlist));
        $("#speechlist").html(tpl_speech(cur.userlist));

        $(".x3Doc>.x3Doc-handle").on("click", function () {
                $(this).siblings(".x3Doc-menu").css("display", "block");
            $(this).siblings(".x3Doc-menu").addClass("x3Doc-click");
        });
    }

    function GenDoc( name, auther, lband, rband )
    {
        var r = [];
        var start = new Date(new Date() - 86400000*rndrange(30,60));
        var c = rndrange(lband,rband);
        for (var j = 0; j < c; j++)
        {
            var x = {};
            x.name = name;
            x.auther = rnditem(auther);
            x.time = new Date(start + (c - j) * 86400000);
            x.stime = tmfmt(x.time,"yy-MM-dd");
            r.push(x);
        }

        return r;
    }

    </script>

</body>
</html>

