<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>啄木鸟风电维保系统</title>
    <script src="js/jquery.js"></script>
    <link rel="stylesheet" href="css/bootstrap.css"/>
    <script src="js/bootstrap.js"></script>
    <script type="text/javascript" src="js/doTe.js"></script>
    <script src="js/utils.js"></script>
    <script src="js/db.js"></script>
    <link rel="stylesheet" href="css/xpecker.css" />
    <script src="js/xpecker.js"></script>
    <link rel="stylesheet" href="css/Cube.css" />
    <script src="js/Cube.js"></script>

    <link rel="StyleSheet" href="css/coord_card.css" type="text/css" />
    <link rel="StyleSheet" href="css/coord_style.css" type="text/css" />
    <script src="js/coord.js"></script>
    <style type="text/css">
        .narrow{}
        .narrow>div>div:first-of-type{width: 165px;}

		.frozenleft{
			display: flex;
			flex-direction: row;
			align-items: baseline;
		}
		.frozenleft>label {
			flex-shrink: 0;
			flex-grow: 0;
			margin:5px;
			margin-left:10px;
			width:56px;
		}
		.frozenleft>div {
			flex-grow: 1;
			margin: 5px;
			padding: 5px 10px;
		}
		.buttonright{
			display: flex;
			flex-direction: row;
			align-items: flex-start;
			
		}
		.buttonright>div{border:1px solid #dddddd;border-radius: 4px;padding: 5px;}
		.buttonright>div:first-of-type {
			flex-grow: 1;
			min-height:30px;
		}
		.buttonright>div:last-of-type {
			flex-shrink: 0;
			flex-grow: 0;
			width: 35px;
			text-align:center;
		}
		
    </style> 
</head>
<body class="xFCsrow">
    <section class="xPanel2 xFIfixed" style="width:300px;">
        <header>任务列表<div style="float: right;"></header>
        <div id="troublelist" class="xScroll" style="height:100px;flex-grow: 1;"></div>
    </section>
    <section class="xPanel2" style="width: 700px; max-width:900px;">
        <header>案件处理</header>
        <div style="height:100px;flex-grow: 1;padding:0px;">
            <details open class="xDetail"><summary style="border-top:0px;">报修<div id="faultedit" style="float: right;"><a href="onclickfaultedit()">编辑</a><a href="onclickfaultsubmit()">提交</a></div></summary><div id="fault"></div></details>
            <details open class="xDetail" id="prepare" ><summary>准备</summary></details>
            <details open class="xDetail"><summary>维修<div style="float: right;"><a href="#">添加</a></div></summary><div id="repair_log"></div></details>
            <details open class="xDetail"><summary>完工</summary><div id="complete"></div></details>
        </div>
    </section>
    <section class="xPanel2 xFIfixed" style="width:200px;min-width:160px;">
        <header>参与人员<div style="float: right;"><a href="#">管理</a></div></header>
        <div id="userlist" class="xScroll" style="height:100px;flex-grow: 1;"><div>asdfasldkjf;lasdkjfasjdfjasdlfjlk</div><div>asdfasldkjf;lasdkjfasjdfjasdlfjlk</div><div>asdfasldkjf;lasdkjfasjdfjasdlfjlk</div></div>
    </section>
    <section class="xPanel2" style="width: 450px; min-width: 300px;">
        <header>对话</header>
        <div id="speechlist" class="xScroll" style="height:100px;flex-grow: 1;"></div>
        <footer class="xFCsrow" style="padding:10px; height: 120px; width: 100%; align-items: flex-end;">
            <textarea class="xrAngle" style="margin-right:10px; padding:5px 10px; height:100px;width:100px;resize:none;"></textarea>
            <div class="xFIfixed"><button>发送</button></div>
        </footer>
    </section>

<script type="text/javascript">
    function crd_card(obj) {
        var tpl = `<div class="card" data_id="{id}">
                <div class="header">
                    <div class="type">报修单</div>
                    <div class="title">{type}</div>
                </div>
                <div class="body" style="text-align:left;">
                    <div><strong>单号：</strong>{code}</div>
                    <div><strong>报修人：</strong>{report_name}</div>
                    <div><strong>联系电话：</strong>{phone}</div>
                    <div><strong>单位：</strong>{winder_name}</div>
                </div>
            </div>`
        return tpl.format(obj);
    }

    function crd_render_fault(fault, fields) {
        var r = '<div class="x2Form narrow">' + RenderPane2(fault, fields) +'</div>';
		if ( fault.imgs.length == 0 )
			fault.imgs =[{"name":"img/blank.png"}];
        r+= `<div class="xHImgList" style="margin:10px;">`+fault.imgs.map(x=>`<img src="`+x.name+`"/>`)+`</div>`;
        r+= `<div id="remark" class="xRndAngle" style="margin:10px;margin-top:5px; padding:5px 10px;">{0}</div>`.format(fault.remark);
        return r;
    }
    function rd_bottle(id, cnt) {
        var r = `<div id="`+id+`"class="buttonright"><div>` + cnt +`</div><div>•••</div></div>`;
        return r;
    }
    function rd_usernail(user) {
		var tpl = `<div class="SmallHead xNail2" style="display: inline-block"><img src="{face}"/>【{prof}】{name}</div>`;
        return tpl.format(user);
    }
</script>

<script type="text/javascript">
    var card, g_focus, g_faults;
	var g_user = parent.g_user;
	if (g_user == undefined) {
		Reqdata("/curuserinf", "", function (res) {
			g_user = res.data;
			g_user.fields = res.fields;
			init();
		});
	}
	else{
		init();
	}

	function init(){
		Reqdata("/rdfault?guide_id=" + g_user.id, "", function (res) {
			g_faults = res;
			GetSub(g_faults.fields, "name", "remark").ftype="none";
			GetSub(g_faults.fields, "name", "winder_id").name="winder_name";
			$("#troublelist").html((g_faults.data.map(x => crd_card(x)).join("")));
			$(".card").on("click", onclickcard);
		});
	}

    function onclickcard(event)
    {
		// 切换焦点
        if (card != undefined)
            card.children(".header").css("background", "linear-gradient(to bottom, rgba(192,215,140,1) 0%,rgba(118,170,73,1) 100%)");
		card = $(event.target).parents(".card");
        card.children(".header").css("background", "linear-gradient(to bottom, rgba(233,209,154,1) 0%,rgba(208,157,80,1) 100%)");
		g_focus=GetSub( g_faults.data, "id", card.attr("data_id") );
		$("#prepare").children("div").remove();
		if (g_focus.status == 0 ){
		
		}

		// 案件信息
		Reqdata("/rd?ls=addit&type=fault_image&ref_id=" + g_focus.id, "", function (res) {
			g_focus.imgs = res.data;
	        $("#fault").html(crd_render_fault(g_focus, g_faults.fields));
		});

        Reqdata("/case/listexpert?fault_id=" + g_focus.id, "", function (res) {
			res.users.forEach(x=>x.prof=GetSub(db_job, "id", x.job).name);
			var html = `<div class="frozenleft"><label>专家组</label><div>`+rd_bottle("expert_list", res.users.map(x=>rd_usernail(x)).join(""))+"</div></div>"
			$("#prepare").append(html);
			return ;
		});

        Reqdata("/case/listengneer?fault_id=" + g_focus.id, "", function (res) {
			res.users.forEach(x=>x.prof=GetSub(db_job, "id", x.job).name);
			var html = `<div class="frozenleft"><label>维修队</label><div>`+rd_bottle("engneer_list", res.users.map(x=>rd_usernail(x)).join(""))+"</div></div>"
			$("#prepare").append(html);
			return ;
		});

		return;

        Reqdata("/rd?ls=addit&type=eval1rep&ref_id=" + fault.id, "", function (res) { xxxrenderimagelist() });
        Reqdata("/rd?ls=addit&type=eval2rep&ref_id=" + fault.id, "", function (res) { xxxrenderimagelist() });
        Reqdata("/rd?ls=addit&type=repairprog&ref_id=" + fault.id, "", function (res) { xxxrenderimagelist() });
        //Reqdata("/rd?ls=link&type=conform&ref_id=" + fault.id, "", function (res) { xxxrenderimagelist() });
        Reqdata("/rd?ls=link&type=repairteam&ref_id=" + fault.id, "", function (res) { xxxrenderimagelist() });
        


        $("#prepare_expert").html(tpl_users(cur.prepare_expert));
        $("#prepare_report").html(tpl_doc(cur.prepare_report));
        $("#prepare_report2").html(tpl_doc(cur.prepare_report2));
        $("#prepare_scheme").html(tpl_scheme(cur.prepare_scheme));
        $("#prepare_windermastersign").html(cur.prepare_windermastersign.who.name);
        $("#prepare_windermastersign").css("background-image","url(img/yin/C_200.png)");
        $("#prepare_winderclerksign").html(cur.prepare_winderclerksign.who.name);
        $("#prepare_winderclerksign").css("background-image", "url(img/yin/C_47.png)");
        $("#prepare_coordmastersign").html(cur.prepare_coordmastersign.who.name);
        $("#prepare_coordmastersign").css("background-image", "url(img/yin/C_123.png)");

        $("#repair_team").html(tpl_users(cur.repair_team));
        $("#repair_mat").html(tpl_nails(cur.repair_mat));
        $("#repair_dev").html(tpl_nails(cur.repair_dev));
        $("#repair_log").html(tpl_repair_log(cur.repair_log));

        $("#complete_report").html(tpl_repairreport(cur.complete_report));
        $("#complete_winderclerksign").html(cur.complete_winderclerksign.who.name);
        $("#complete_winderclerksign").css("background-image", "url(img/yin/C_47.png)");
        $("#complete_repairteamldrsign").html(cur.complete_repairteamldrsign.who.name);
        $("#complete_repairteamldrsign").css("background-image", "url(img/yin/C_98.png)");
        $("#userlist").html(tpl_userlist(cur.userlist));
        $("#speechlist").html(tpl_speech(cur.userlist));

        $(".x3Doc>.x3Doc-handle").on("click", function () {
                $(this).siblings(".x3Doc-menu").css("display", "block");
            $(this).siblings(".x3Doc-menu").addClass("x3Doc-click");
        });
    }

	function onclickfaultedit(){

	}

	function onclickfaultsubmit(){

	}

    function GenDoc( name, auther, lband, rband )
    {
        var r = [];
        var start = new Date(new Date() - 86400000*rndrange(30,60));
        var c = rndrange(lband,rband);
        for (var j = 0; j < c; j++)
        {
            var x = {};
            x.name = name;
            x.auther = rnditem(auther);
            x.time = new Date(start + (c - j) * 86400000);
            x.stime = x.time.format("yy-MM-dd");
            r.push(x);
        }

        return r;
    }

    </script>

</body>
</html>

