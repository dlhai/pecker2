<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>啄木鸟风电维保系统</title>
    <script src="js/jquery.js"></script>
    <link rel="stylesheet" href="css/bootstrap.css"/>
    <script src="js/bootstrap.js"></script>
    <script type="text/javascript" src="js/doTe.js"></script>
	<script src="laydate/laydate.js"></script>
    <script charset="utf-8" src="kindedit/kindeditor-all.js"></script>
    <script charset="utf-8" src="kindedit/lang/zh-CN.js"></script>
    <script src="js/utils.js"></script>
    <script src="js/db.js"></script>
    <link rel="stylesheet" href="css/xpecker.css" />
    <script src="js/xpecker.js"></script>
    <link rel="stylesheet" href="css/Cube.css" />
    <script src="js/Cube.js"></script>
	<link rel="stylesheet" href="css/speech.css" />
    <link rel="StyleSheet" href="css/case.css" type="text/css" />
	<script>
// 案件界面，用于调度、专家、风场场主、驻场、队长等，当前仅含案件编辑功能的内容，后面会加入案件显示的内容。
function crd_showuserselectdlg() {
    var us = `<div id="rolelist" class="xCombox xRndAngle" style="margin-top:5px; display:inline-block;"><span>调度人员</span><div class="xMenu">
                <div class="selected">调度人员</div><div>风场人员</div><div>设备人员</div><div>仓库人员</div><div>专家</div><div>维修人员</div>
            </div></div>
            <div id="userfilter" class="xCombox xRndAngle" style="margin-top:5px; display:inline-block;">
                <span>所有</span><div id="userfiltertree" class="xMenu" style="max-height:600px;overflow-y:auto;"><div class="selected">调度人员</div></div>
            </div>
            <div id="filteruserlist" class="xRndAngle xScroll" style="margin-top:5px; width:590px;height:250px;padding:5px;"></div>`

    var dlg = new cbDlg("人员选择", "width:610px");
    dlg.Add(us);
    dlg.Show();
}

var ud_sels=[] // 当前已选中的人员列表
var ud_filter2 = "";
function ud_userdlg( filter1, filter2, sels, cb) {
	ud_sels = sels;
	ud_filter2 = filter2
    var us = 
			`<div id="rolelist" class="xCombox xRndAngle" style="margin-top:5px; display:inline-block;">
				<span></span>
				<div class="xMenu"></div>
			</div>
            <div id="userfilter" class="xCombox xRndAngle" style="margin-top:5px; display:inline-block;">
                <span></span>
				<div id="userfiltertree" class="xMenu" style="max-height:600px;overflow-y:auto;">
				</div>
            </div>
            <div id="filteruserlist" class="xRndAngle xScroll" style="margin-top:5px; width:590px;height:250px;padding:5px;"></div>`
    var dlg = new cbDlg("人员选择", "width:610px");
    dlg.Add(us);
    dlg.Show();
	dlg.submit = function(thedlg){
		var ar = $("#filteruserlist input").toArray().filter(x=>$(x).prop('checked')).map(x=>$(x).attr("data_id"));
		if ( cb(ar) ){
			thedlg.closedlg();
		}
	}

	var roles = filter1 != "" ? filter1: ["调度人员","风场人员","设备人员","仓库人员","专家","维修队"];
	ud_cbx("rolelist",roles, roles[0] );
	onclkrole(roles[0],filter2);
}

function ud_cbx(id, items, dft ) {
	$("#"+id+" span").html(dft);
	if (typeof items[0] == "string")
		$("#"+id+" div").html(items.map(x=>"<div>"+x+"</div>").join(""));
	else
		$("#"+id+" div").html(items.map(x=>`<div data_id="{id}" >{name}</div>`.format(x)).join(""));
}

//点在菜单项上
$("html").on("click", function (event) {
    var node = $(event.target);
    if (node.parent().hasClass("xMenu")) { //点在菜单背景上
        var parentid = node.parent().parent().attr("id");
        if (parentid == "rolelist") {
           onclkrole($(node).html(),ud_filter2);
        }
        else if (parentid == "userfilter") {
			var filter2 = node.attr("data_id");
			if ( filter2 == undefined )
				filter2 = node.html();
			onclkfilter(filter2);
        }
    }
});

function rd_checkuser(user) {
    var tpl = `<label style="margin-right:10px;font-weight:normal;"><input data_id="{0}" type="checkbox" {2} >{1}</label>`;
    return tpl.format(user.id,rd_brief(user), ud_sels.some(x=>x.id==user.id)? "checked":"");
}

function onclkrole(text, filter2){
	if (text == "调度人员") {
        $("#userfilter span").html('所有　　');
        $("#userfiltertree").addClass('xMenu');
        $("#userfiltertree").removeClass('xPopWnd');
        $("#userfiltertree").html('<div class="selected">所有　　</div>');
        Reqdata("/user/briefs?job=" + GetsubJob(GetSub(db_job, "name", "调度超级帐号").id, "string"), "", function (res) {
			res.users.forEach(x=>x.prof=GetSub(db_job, "id", x.job).sname);
            $("#filteruserlist").html(res.users.map(x => rd_checkuser(x)));
        });
    }
    else if (text == "风场人员") {
        $("#userfilter span").html('　　　　　　');
        $("#userfiltertree").html('');
        $("#userfiltertree").addClass('xPopWnd');
        $("#userfiltertree").removeClass('xMenu');
        $("#filteruserlist").html("");
        g.userfiltertree = new x4Tree("#userfiltertree", "winderco", "", "winder", function (type, id, node) {
            if (type == "winder") {
                $("#userfilter>span").html(node.html());
                $("#userfilter .xPopWnd").toggle();
                Reqdata("/user/briefs?depart_id=" + id + "&depart_table=" + GetTbl("winder").id, "", function (res) {
					res.users.forEach(x=>x.prof=GetSub(db_job, "id", x.job).sname);
                    $("#filteruserlist").html(res.users.map(x => rd_checkuser(x)));
                });
            }
            else {
                g.userfiltertree.Extend("#" + type + "_" + id);
            }
        });
    }
    else if (text == "设备人员") {
        $("#userfilter span").html('　　　　　　');
        $("#userfiltertree").addClass('xPopWnd');
        $("#userfiltertree").removeClass('xMenu');
        $("#userfiltertree").html('');
        $("#filteruserlist").html('');
        g.userfiltertree = new x4Tree("#userfiltertree", "devwh", "", "devwh", function (type, id, node) {
            if (type == "devwh") {
                $("#userfilter>span").html(node.html());
                $("#userfilter .xPopWnd").toggle();
                Reqdata("/user/briefs?depart_id=" + id + "&depart_table=" + GetTbl("devwh").id, "", function (res) {
					res.users.forEach(x=>x.prof=GetSub(db_job, "id", x.job).sname);
                    $("#filteruserlist").html(res.users.map(x => rd_checkuser(x)));
                });
            }
            else {
                g.userfiltertree.Extend("#" + type + "_" + id);
            }
        });
    }
    else if (text == "仓库人员") {
        $("#userfilter span").html('　　　　　　');
        $("#userfiltertree").addClass('xPopWnd');
        $("#userfiltertree").removeClass('xMenu');
        $("#userfiltertree").html('');
        $("#filteruserlist").html('');
        g.userfiltertree = new x4Tree("#userfiltertree", "matprov", "", "matwh", function (type, id, node) {
            if (type == "matwh") {
                $("#userfilter>span").html(node.html());
                $("#userfilter .xPopWnd").toggle();
                Reqdata("/user/briefs?depart_id=" + id + "&depart_table=" + GetTbl("matwh").id, "", function (res) {
					res.users.forEach(x=>x.prof=GetSub(db_job, "id", x.job).sname);
                    $("#filteruserlist").html(res.users.map(x => rd_checkuser(x)));
                });
            }
            else {
                g.userfiltertree.Extend("#" + type + "_" + id);
            }
        });
    }
    else if (text == "专家") {
        $("#userfilter span").html('所有　　　　');
        $("#userfiltertree").addClass('xMenu');
        $("#userfiltertree").removeClass('xPopWnd');
        $("#userfiltertree").html('<div id="user_0">所有</div>' + xrmenuin(db_skill, "skill_"));
        Reqdata("/user/briefs?job=14", "", function (res) {
			res.users.forEach(x=>x.prof=GetSub(db_job, "id", x.job).sname);
            $("#filteruserlist").html(res.users.map(x => rd_checkuser(x)));
        });
    }
    else if (text == "维修队") {
        $("#userfiltertree").addClass('xMenu');
        $("#userfiltertree").removeClass('xPopWnd');
        Reqdata("/user/briefs?job=16", "", function (res) {
			if (filter2 != "")
				res.users = res.users.filter(x=>x.id==filter2);
			if (res.users.length == 1){
				ud_cbx("userfilter",res.users, res.users[0].name );
				onclkfilter(res.users[0].id);
			}
			else
				ud_cbx("userfilter",res.users, "　　　　" );
        });
    }
    else if (text == "维修人员") {
        $("#userfiltertree").addClass('xMenu');
        $("#userfiltertree").removeClass('xPopWnd');

		var ar = filter2 != "" ? filter2: ["所有","队长","技工"];
		ud_cbx("userfilter",ar, ar[0] );
		onclkfilter(ar[0]);
    }
}

	function onclkfilter(filter2){
        var role = $("#rolelist span").html();
        if (role == "专家") {
            Reqdata("/user/briefs?job=14", "", function (res) {
				if (filter2 != "所有")
					res.users = res.users.filter(x=>x.skill.indexOf(filter2)!= -1);
				res.users.forEach(x=>x.prof=GetSub(db_job, "id", x.job).sname);
                $("#filteruserlist").html(res.users.map(x => rd_checkuser(x)));
            });
        }
        else if (role == "维修队") {
            Reqdata("/rdteam?user_id=" + filter2, "", function (res) {
				res.data.forEach(x=>x.prof=GetSub(db_job, "id", x.job).sname);
                $("#filteruserlist").html(res.data.map(x => rd_checkuser(x)));
            });
        }
        else if (role == "维修人员") {
			var job = filter2=="队长"?16:filter2=="技工"?17:"(16,17)";
            Reqdata("/user/briefs?job=" + job, "", function (res) {
				res.users.forEach(x=>x.prof=GetSub(db_job, "id", x.job).sname);
                $("#filteruserlist").html(res.users.map(x => rd_checkuser(x)));
            });
        }
	}
	</script>

</head>
<body class="xFCsrow">
    <section class="xPanel2 xFIfixed" style="width:300px;">
        <header>任务列表<div style="float: right;"></header>
        <div id="troublelist" class="xScroll" style="height:100px;flex-grow: 1;"></div>
    </section>
    <section class="xPanel2" style="width: 700px; max-width:900px;">
        <header>案件处理</header>
        <div id="case" class="xScroll" style="height:100px;flex-grow: 1;padding:0px;">
        </div>
    </section>
    <section class="xPanel2 xFIfixed" style="width:200px;min-width:160px;">
        <header>参与人员<div style="float: right;"><a href="#">管理</a></div></header>
        <div id="chatman" class="xScroll" style="height:100px;flex-grow: 1;"></div>
    </section>
    <section class="xPanel2" style="width: 450px; min-width: 300px;">
        <header>对话</header>
		<div id="speechlist" class="xScroll" style="height:100px;flex-grow: 1;"></div>
		<footer id="speechinput" class="xFCsrow xFIfixed" style="padding:0px 10px 10px 0px; height: 200px; width: 100%; align-items: flex-end;">
			<textarea id="kereplay" class="xrAngle" style="margin-right:10px; padding:5px 10px; height:188px;width:100px;resize:none;"></textarea>
			<div class="xFIfixed"><button onclick="onsend()">发送</button></div>
		</footer>
    </section>

<script type="text/javascript">
    function crd_card(obj) {
        var tpl = `<div class="card" data_id="{id}">
                <div class="header">
                    <div class="type">报修单</div>
                    <div class="title">{type}</div>
                </div>
                <div class="body" style="text-align:left;">
                    <div><strong>单号：</strong>{code}</div>
                    <div><strong>报修人：</strong>{report_name}</div>
                    <div><strong>联系电话：</strong>{phone}</div>
                    <div><strong>单位：</strong>{winder_name}</div>
                </div>
            </div>`
        return tpl.format(obj);
    }

    function crd_render_fault(fault, fields) {
		var r =`<details open class="xDetail2"><summary style="border-top:0px;">报修</summary><div>`
        r += '<div class="x2Form narrow">' + RenderPane2(fault, fields, f2s) +'</div>';
		if ( fault.imgs.length == 0 )
			fault.imgs =[{"name":"img/blank.png"}];
        r+= `<div class="xHImgList" style="margin:10px;">`+fault.imgs.map(x=>`<img src="`+x.name+`"/>`).join("")+`</div>`;
		r+=`</div></details>`;
        return r;
    }

    function rd_frozenleft(title, cnt) {
        var r = `<div class="frozenleft"><label>`+title+`</label>`+cnt+"</div>";
        return r;
    }

    function rd_buttonright(id, cnt) {
        var r = `<div id="`+id+`"class="buttonright"><div>` + cnt +`</div><div id="btn_`+id+`" >编辑</div></div>`;
        return r;
    }

	// 文档组合框
    function rd_doc(id, docs ) {
        var r = `<div id="`+id+`" class="buttonright" style="width:100px;"><div class="xCombox"><span>`
				+ ( docs.length > 0 ? docs[0].name :"　")
				+ `</span><div class="xPopWnd xdoclist">`
				+ docs.map(x=>"<div>"+x.name+"</div>").join("")
				+ `</div></div><div id="btn_`+id+`"><label>上传<input type="file"/></label></div></div>`;
        return r;
    }

	// 带签字的文档组合框
    function rd_doc2(id, docs, signs, signers) {
		var img = {"2":"img/风场.png","3":"img/驻场.png","11":"img/调度长.png","16":"img/队长.png"};
        var doc = `<div id="`+id+`" class="buttonright" style="width:100px;"><div class="xCombox"><span>`
				+ ( docs.length > 0 ? docs[0].name :"　")
				+ `</span><div class="xPopWnd xdoclist">`
				+ docs.map(x=>"<div>"+x.name//+`<div style="float:right;">`
				+ signs.filter(y=>y.a_id==x.id).map(y=>{
					var u = GetSub( signers, "id", y.b_id);
					return `<span class="sign"><img src="`+img[y.remark]+`">`+u.name+`</span>` // y.remark是签字时的职业
					}).join(" ")
				+ "</div>").join("")
				+ `</div></div><div id="btn_`+id+`"><label>上传<input type="file"  /></label></div></div>`;
		var sign = `<div id=`+id+`_sign" class="buttonright" style="width:100px;"><div>`
					+ ( signs.length == 0 ? "　":signs.map(y=>{
						var u = GetSub( signers, "id", y.b_id);
						return `<span class="sign"><img src="`+img[y.remark]+`">`+u.name+`</span>` // y.remark是签字时的职业
					}).join(" "))+`</div><div id="btn_`+id+`sign" style="width:70px;">我要签字</div></div>`; // 签字
        return doc + sign;
    }

    function rd_brief(user) {
		var tpl = `<div class="brief"><img src="{face}"/>【{prof}】{name}</div>`;
        return tpl.format(user);
    }

	function rd_statusright(html,status) {
		return `<div class="statusright"><div>`+html+`</div><div>`+status+`</div></div>`;
	}

	// 维修用料
    function rd_matrec( matoutrec ) {
		var status = {"": "未指派","0": "未提交" ,"1": "已提交" ,"2": "正在备货" ,"3": "等待审批" ,
					 "4": "等待发货" ,"5": "等待收货" ,"6": "风场已收" ,"-1": "退回" }
		var mat = GetSub(g_mats.data, "id", matoutrec.mat_id);
		return rd_statusright(mat.name+"("+mat.type+")", status[matoutrec.status]);
    }

	// 维修设备
    function rd_device( devwork ) {
		var status = { "": "未指派" ,"0": "编辑" ,"1": "已提交" ,"2": "已指派" ,
					"3": "前往现场" ,"4": "工作中" ,"5": "完成" ,"-1": "退回" };
		var clss = GetSub(db_devclss, "id", devwork.clss).name;
		return rd_statusright(clss+"("+devwork.type+")", status[devwork.status]);
    }

	// 维修记录
    function rd_repairlog( logs,imgs,users ) {
		logs.forEach((x,i)=>{
			x.imgs = imgs.filter(y=>y.ref_id==x.id);
			x.user = users.filter(y=>y.id==x.user_id)[0];
		});

		var tpl = doT.template(`<table class="xTable">
		<thead><tr><th>现场图片</th><th>说明</th><th>发表人</th></tr></thead>
		{% it.forEach((x,i)=>{ %}
		<tr>
			<td>
				<div class="xHImgList" style="border:0px;">
				{% x.imgs.forEach((y,i)=>{ %}
				<img src="{%=y.name%}"/>
				{% }); %}
				</div>
			</td>
			<td  style="max-width: 250px;">{%=x.remark%}</td>
			<td>
				<div><span class="SmallHead"><img src="{%=x.user.face%}"/>【{%=x.user.prof%}】{%=x.user.name%}</span></div>
				<div>{%=x.date%}</div>
			</td>
		</tr>
		{% }); %}
		</table>`);
		return tpl(logs);
	}

    function rd_speech(speech) {
        if (speech.src != g_user.id) {
            var user=GetSub(g_focus.chatmen,"id",speech.user_id);

			tpl=`<div class="lspeech">
					<div><img src="{face}" /></div>
					<div>
						<span>【{prof}】{name}</span>
						{date}
						<div>{say}</div>
					</div>
				</div>`
            r = tpl.format(mix(speech,user))
        }
        else {
            r =`<div class="rspeech">
					<div>
						{date}
						<span>【{prof}】{name}</span>
						<div>{say}</div>
					</div>
					<div><img src="{face}" /></div>
            </div>`.format(mix(speech,g_user))
        }
        return r;
    }

</script>

<script type="text/javascript">
    var g_focus_card, g_focus, g_faults;
	var g_user = parent.g_user;
	if (g_user == undefined) {
		Reqdata("/curuserinf", "", function (res) {
			g_user = res.data;
			g_user.fields = res.fields;
			init();
		});
	}
	else{
		init();
	}
	function init(){
    $("body").on("click", function (event) {
        var node = $(event.target);
		var id = node.attr("id");
		if ( id != undefined && id.indexOf("btn_") == 0 ){
			onclickButton(node);
		}
    });

		Reqdata("/rd?ls=mat", "", function (mats) {g_mats = mats;});
		var int=self.setInterval( checkchange,10000);
		checkchange();
	}

	var kereplay;
	KindEditor.ready(function (K) {
		kereplay = K.create('#kereplay', {
			uploadJson: '/cr', resizeMode:0,items: ['cut', 'copy', 'paste', '|', 'formatblock', 'fontname', 'fontsize', 'forecolor', 'hilitecolor', 'bold', 'italic',
				'underline', 'removeformat', '|', 'link', 'unlink', '|', 'fullscreen',]
		});
	});

	function checkchange(){
		Reqdata("/case/rdfault"+ (g_faults == undefined? "":"?maxid="+g_faults.maxid), "", function (res) {
			if (g_faults != undefined && g_faults.maxid == res.maxid)
				return; // 没有新数据
			g_faults = res;
            res.fields.push({ "title": "报修风机", "name": "devices", "forder": "5", "ftype": "div_long" });
            xfieldsort(res.fields);
			$("#troublelist").html((g_faults.data.map(x => crd_card(x)).join("")));
			$(".card").on("click", onclickcard);

			if ( g_focus != undefined){ // 恢复之前的选中状态
				$("[data_id="+g_focus.fault.id+"]").children(".header").css("background", "linear-gradient(to bottom, rgba(233,209,154,1) 0%,rgba(208,157,80,1) 100%)");
			}
		});
	}

    function onclickcard(event)
    {
		// 切换焦点
        if (g_focus_card != undefined)
            g_focus_card.children(".header").css("background", "linear-gradient(to bottom, rgba(192,215,140,1) 0%,rgba(118,170,73,1) 100%)");
		g_focus_card = $(event.target).parents(".card");
        g_focus_card.children(".header").css("background", "linear-gradient(to bottom, rgba(233,209,154,1) 0%,rgba(208,157,80,1) 100%)");
		RenderCase(g_focus_card.attr("data_id"));
	}
	function RenderCase(id){
		Reqdata("/case/detail?id=" + id, "", function (res) {
			if (!g_faults.data.some(x=>x.id==id)){ // 在fault列表产生变动的情况下，如删除，退回、完工等，会出现id不在fault列表中
				$("#case").html("");
				$("#chatman").html("");
				$("#speechlist").hide();
				$("#speechinput").hide();
				return;
			}

			g_focus = res;
			g_focus.experts.forEach(x=>x.prof=GetSub(db_job, "id", x.job).sname);
			g_focus.engineers.forEach(x=>x.prof=GetSub(db_job, "id", x.job).sname);
			g_focus.repairlog_users.forEach(x=>x.prof=GetSub(db_job, "id", x.job).sname);
			g_focus.chatmen.forEach(x=>x.prof=GetSub(db_job, "id", x.job).sname);

	        var html = crd_render_fault(g_focus.fault, g_faults.fields);

			if (g_focus.fault.status == 0 ){
				html += `<div style="margin:20px;border-top:2px dashed #6a923d;padding-top:30px;">
							<button id="btn_modify" type="button" class="btn btn-primary">编辑</button>
							<div style="float: right;">
								<div id="sect_flow" class="x2Form" style="display:inline-block;">
									<div><label>意见</label><input id="note" style="width:400px;"/></div>
								</div>
								<button id="btn_submit" type="button" class="btn btn-primary">提交</button>
							</div>
						</div>`;//工具条
				$("#case").html(html);
				$("#chatman").html("");
				$("#speechlist").hide();
				$("#speechinput").hide();
			}
			else if (g_focus.fault.status == 1 ){
				if (g_user.job == 2 || g_user.job == 3){ // 风场长或驻场
					html += `<div style="margin:20px;border-top:2px dashed #6a923d;padding-top:30px;">
								<button id="btn_recall" type="button" class="btn btn-default" style="color:#aaaaaa;display">撤回</button>
							 </div>`;//工具条
				}
				else if (g_user.job == 11 || g_user.job == 12){ // 调度长或调度
					html += `<div style="margin:20px;border-top:2px dashed #6a923d;padding-top:30px;">
								<div style="float: right;">
									<div id="sect_flow" class="x2Form" style="display:inline-block;">
										<div><label>意见</label><input id="note" style="width:400px;"/></div>
									</div>
									<button id="btn_accept" type="button" class="btn btn-primary">接单</button>
									<button id="btn_decline" type="button" class="btn btn-primary">退回</button>
								</div>
							</div>`;//工具条
				}
				$("#case").html(html);
				$("#chatman").html("");
				$("#speechlist").html("");
				$("#speechlist").hide();
				$("#speechinput").hide();
			}
			else{
				$("#speechlist").show();
				$("#speechinput").show();
				html += `<details open class="xDetail2"><summary>准备</summary><div>`;
				html += rd_frozenleft("专家组",rd_buttonright("experts", g_focus.experts.map(x=>rd_brief(x)).join("")));
				html += rd_frozenleft("评估报告",rd_doc("eval1",g_focus.eval1rep)+rd_doc("eval2",g_focus.eval2rep));
				html += rd_frozenleft("维修方案",rd_doc2("plan",g_focus.repairplan,g_focus.repairplan_sign,g_focus.repairplan_signers));
				html += rd_frozenleft("维修队",rd_buttonright("works", g_focus.engineers.map(x=>rd_brief(x)).join("")));
				html += rd_frozenleft("维修用料",rd_buttonright("mats", g_focus.matoutrecs.map(x=>rd_matrec(x)).join("")));
				html += rd_frozenleft("维修设备",rd_buttonright("devs", g_focus.devworks.map(x=>rd_device(x)).join("")));
				html += `</div></details>`;
	
				if (g_focus.repairlog.length>0 || g_user.job == 16|| g_user.job == 17){ // 队长或技工
					html += `<details open class="xDetail2"><summary>维修<div style="float: right;"><a id="btn_log" href="#">添加</a></div></summary><div id="repair_log">`;
					html += rd_repairlog(g_focus.repairlog, g_focus.repairlog_imgs, g_focus.repairlog_users);
					html += `</div></details>`;
				}
				if (g_focus.repairrep.length>0 || g_user.job == 16){ // 队长
					html += `<details open class="xDetail2"><summary>完工</summary><div>`
					html += rd_frozenleft("维修报告",rd_doc2("report",g_focus.repairrep,g_focus.repairrep_sign,g_focus.repairrep_signers));
					html += `</div></details>`;
				}

				if (g_user.job == 11 || g_user.job == 12){ // 调度长或调度
					html += `<div style="margin:20px;border-top:2px dashed #6a923d;padding-top:30px;">
								<div style="float: right;">
									<div id="sect_flow" class="x2Form" style="display:inline-block;">
										<div><label>意见</label><input id="note" style="width:400px;"/></div>
									</div>
									<button id="btn_finish" type="button" class="btn btn-primary">完工</button>
								</div>
							</div>`;//工具条
				}
				
				$("#case").html(html);

				var btnstatus = {// 功能按钮分角色控制
					/*风场长*/  "2": { "experts": "h","eval1": "h", "eval2": "h", "plan": "h", "plansign": "s",  "works": "h", "mats": "h", "devs": "h",  "log": "s", "report": "h", "reportsign": "s",},
					/*驻场*/    "3": { "experts": "h","eval1": "h", "eval2": "h", "plan": "h", "plansign": "s",  "works": "h", "mats": "h", "devs": "h",  "log": "s", "report": "h", "reportsign": "s",},
					/*调度长*/ "11": { "experts": "s","eval1": "h", "eval2": "h", "plan": "s", "plansign": "s",  "works": "s", "mats": "s", "devs": "s",  "log": "h", "report": "h", "reportsign": "h",},
					/*调度*/   "12": { "experts": "h","eval1": "h", "eval2": "h", "plan": "s", "plansign": "h",  "works": "s", "mats": "s", "devs": "s",  "log": "h", "report": "h", "reportsign": "h",},
					/*专家*/   "14": { "experts": "h","eval1": "s", "eval2": "s", "plan": "h", "plansign": "h",  "works": "h", "mats": "h", "devs": "h",  "log": "h", "report": "h", "reportsign": "h",},
					/*队长*/   "16": { "experts": "h","eval1": "h", "eval2": "h", "plan": "h", "plansign": "h",  "works": "s", "mats": "h", "devs": "h",  "log": "s", "report": "s", "reportsign": "h",},
					/*技工*/   "17": { "experts": "h","eval1": "h", "eval2": "h", "plan": "h", "plansign": "h",  "works": "h", "mats": "h", "devs": "h",  "log": "s", "report": "h", "reportsign": "h",},
				};
				$.each(btnstatus[g_user.job], (k, v) => { v == "s" ? $("#btn_"+k).show() : $("#btn_"+k).hide() });
				
				$("#chatman").html(g_focus.chatmen.map(x=>rd_brief(x)).join(""));
				$("#speechlist").html(g_focus.speechlist.map(x=>rd_speech(x)).join(""));
			}
		});
    }

	function onclickButton(node){
		var id = node.attr("id");
		if ( id == "btn_modify" ){
            var dlg = new cbFormDlg();
            dlg.title = "报修单";
            dlg.css = "width:610px";
            dlg.Add(RenderForm4(g_focus.fault, g_faults.fields, f2s));
            dlg.Add(xrimagelistlive2("image", g_focus.fault.imgs.map(x=>x.name)));
			dlg.urlremove = "/case/faultremove?id=" + g_focus.fault.id;
			dlg.urlsubmit = "/case/faultmodify?id="+g_focus.fault.id;
			dlg.closing = function (reason){
				if ( reason == "remove"){
					g_focus = undefined;
					g_faults = undefined;
					checkchange();
				}
				else if (reason == "submit"){
					RenderCase(g_focus.fault.id)
					checkchange();
				}
			}
			dlg.Show();
		}
		else if ( id == "btn_submit" ){
			chgstatus("btn_submit");
		}
		else if ( id == "btn_recall" ){
			chgstatus("btn_recall");
		}
		else if ( id == "btn_accept" ){
			chgstatus("btn_accept");
		}
		else if ( id == "btn_decline" ){
			chgstatus("btn_decline");
		}
		else if ( id == "btn_finish" ){
			chgstatus("btn_finish");
		}
		else if ( id == "btn_experts" ){
			ud_userdlg(["专家"], "", g_focus.experts, function(ar){
				if (ar.length == 0){
					alert("至少选一个专家");
					return;
				}
				var fd = new FormData();
				fd.append("id", g_focus.fault.id);
				fd.append("expert", ar);
				postform("/case/setexpert", fd, "", function (res) {RenderCase(g_focus.fault.id);});
				return true;
			});
		}
		else if ( id == "btn_eval1" ){
		
		}
		else if ( id == "btn_eval2" ){
		
		}
		else if ( id == "btn_plan" ){
			
		}
		else if ( id == "btn_plansign" ){
		
		}
		else if ( id == "btn_works" ){
			if (g_user.job ==11 || g_user.job ==12 ) {// 调度或调度长，指定队长
				ud_userdlg(["维修人员"],"队长",g_focus.engineers, function(ar){
					if (ar.length != 1){
						alert("要求有且仅有一个队长");
						return;
					}
					else if ( g_focus.engineers.length > 0 ){
						if ( !confirm("更换队长将更换整个施工队，要继续吗？"))
							return;
					}
					var fd = new FormData();
					fd.append("id", g_focus.fault.id);
					fd.append("leader", ar[0]);
					postform("/case/setteam", fd, "", function (res) {RenderCase(g_focus.fault.id);});
					return true;
				});
			}
			else if (g_user.job ==16 ) {// 队长，添加队员
				ud_userdlg(["维修队"],g_user.id,g_focus.engineers, function(ar){
					var fd = new FormData();
					fd.append("id", g_focus.fault.id);
					fd.append("leader", g_user.id);
					fd.append("engineers", ar);
					postform("/case/setteam", fd, "", function (res) {RenderCase(g_focus.fault.id);});
					return true;
				});
			}
		}
		else if ( id == "btn_mats" ){
		
		}
		else if ( id == "btn_devs" ){
		
		}
		else if ( id == "btn_log" ){
		
		}
		else if ( id == "btn_report" ){
		
		}
		else if ( id == "btn_reportsign" ){
		
		}
		else{
			alert("click "+id);
		}
	}

    function chgstatus(action) {
        var fd = new FormData();
        fd.append("id", g_focus.fault.id);
        fd.append("action", action);
        fd.append("status", g_focus.fault.status);
		fd.append("maxid", g_focus.maxid);
		var note =$("#note");
		if (note.length != 0 )
			fd.append("note", note[0].value);
		else
			fd.append("note", "");
        postform("/case/chgstatus", fd, "", function (res) {
            if (res.result == "200") {
				checkchange();
				RenderCase(g_focus.fault.id);
                alert("操作成功！");
            }
			else if (res.result == "405") {
				checkchange();
				RenderCase(g_focus.fault.id);
			}
        });
    }

	function f2s(u,f){
		var f = (typeof f == "string"?f:f.name);
		if (f=="devices"){
			var h = "";
			if ( u.efans.length >0 )
					h+="风机："+u.efans.map(x=>x.code).join(",");
			if ( u.leafs.length >0 )
					h+="叶片："+u.leafs.map(x=>x.code).join(",");
			return h;
		}
		else if ( f == "report_id") return u["report_name"];
		else if ( f == "winder_id") return u["winder_name"];
		return u[f];
	}

$("html").on("change", function (event) {
    var node = event.target;
    if (node.tagName == "INPUT" && node.type == "file") { // 可点击换图的图片列表
		alert($(node).parents(".buttonright").attr("id"));
    }
});
    

</script>
</body>
</html>

