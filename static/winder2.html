<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>啄木鸟风电维保系统</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <link rel="stylesheet" href="css/bootstrap.css"/>
    <script type="text/javascript" src="js/doTe.js"></script>
    <script src="js/jquery.js"></script>
    <script src="js/bootstrap.js"></script>
    <script src="laydate/laydate.js"></script>
    <script src="js/utils.js"></script>
    <script src="js/db.js"></script>
    <link rel="stylesheet" href="css/xpecker.css" />
    <script src="js/xpecker.js"></script>
    <link rel="stylesheet" href="css/Cube.css" />
    <script src="js/Cube.js"></script>
</head>
<body class="xFCscol">
    <section class="xPanel2">
        <header class="heading">风电机列表
            <div style="float: right;">
                <a onclick="onSelect(this)">全选</a> <a onclick="onSelect(this)">全消</a> <a onclick="onSelect(this)">反选</a> <a onclick="onRepair()" style="margin-left:20px;">报修</a>
                <a onclick="onQueryLog()">记录</a> <a onclick="onImport()" style="margin-left:20px;">导入</a> <a onclick="onNew()">添加</a>
            </div>
        </header>
        <div id="item_list" class="xScroll" style="padding: 5px; flex-grow: 1;"></div>
    </section>
    <script id="tpl_efan_import" type="text/template">
        <div style="margin: 10px 15px;">
            <div>为 当前风场 批量导入 风电机</div>
            <div style="margin:5px 0px;">表格请按照模板填写，点此下载模板</div>
            <input type="file" id="upload_efan" name="upload_efan" /><input type="button" value="上传" onclick="uploadFile()" />
            <div style="border:1px solid #dddddd;width:100%;height:15px;"><div id="progress" style="background-color:#0094ff;width:50%;height:100%;"></div></div>
        </div>
    </script>
    <script type="text/javascript">
        var g_user = parent.g_user, g_winderarea_id = GetParam("id"), g_efanvenders, g_leafvenders, g_efans, g_leafs;
        if (g_user == undefined) {
            g_user = GetRoleUser("风场主管");
            Reqdata("/rd?ls=winderarea&winder_id=" + g_user.depart_id, "", function (sub) {
                g_user.sub = sub.data;
                g_winderarea_id = sub.data[0].id;
                init();
            });
        }
        else{
            init();
        }

        function init(){
            var count = 0;
            Reqdata("/rd?ls=vender&type=" + GetTbl("efan").id, "", function (efanv) { g_efanvenders = efanv; count += 1; if (count == 4) Render(); });
            Reqdata("/rd?ls=vender&type=" + GetTbl("leaf").id, "", function (leafv) { g_leafvenders = leafv; count += 1; if (count == 4) Render();});
            Reqdata("/rd?ls=efan&winderarea_id=" + g_winderarea_id, "", function (efan) { g_efans = efan; count += 1; if (count == 4) Render();});
            Reqdata("/rd?ls=leaf&winderarea_id=" + g_winderarea_id, "", function (leaf) { g_leafs = leaf; count += 1; if (count == 4) Render(); });
        }
        function Render(){
            for (var i in g_efans.data) {
                g_efans.data[i].leafs = new Array();
                for (var j in g_leafs.data) {
                    if (g_efans.data[i].id == g_leafs.data[j].efan_id ) {
                        g_efans.data[i].leafs.push(g_leafs.data[j]);
                    }
                }
            }
            var html = "";
            var pane = new EFanPane(true);
            for (var i in g_efans.data) {
                html += pane.Render(g_efans.data[i]);
            }

            $("#item_list").html(html);
        }

        function onSelect(This) {
            var txt = $(This).html();
            var inputs = $("#item_list").find("input");
            if (txt == "全选")
                inputs.prop("checked", true);
            else if (txt == "全消")
                inputs.prop("checked",false);
            else
                inputs.each(function () {$(this).prop('checked', !$(this).prop("checked"));});
        }
        function onRepair() {
            Reqdata("/rd?ls=fault&id=0", "", res => {
                var dlg = new cbDlg();
                dlg.title = "报修";
                dlg.css = "width:610px";

                res.fields.push({ "title": "报修设备", "name": "devices", "forder": "2", "ftype": "div_long" } );
                xfieldsort(res.fields);
                var data = Create(res.fields);
                data.devices = "qweqwe,asdasd,zxzxc,ewrwer,werwer,sdfsdf,erwert";
                data.winder_id = "xxx风场";
                data.report_id = "xxx驻场人";
                dlg.Add(RenderForm4(data, res.fields));
                dlg.Add(xrimagelistlive([""]));
                dlg.Show();
            });
        }
        function onQueryLog() {
            alert("asdfs");
        }

        function onNew() {
            var efan = EFanCreate(g_efans.fields, g_leafs.fields, g_user.depart_id, g_winderarea_id);
            var form = new EfanForm();
            var dlg = new cbDlg();
            dlg.title = "新建 风电机";
            dlg.css="width:610px";
            dlg.Add(form.Render(efan));
            dlg.Show();
            var nodes = $("select");
            nodes[0].selectedIndex = -1;
            nodes[1].selectedIndex = -1;
            nodes[2].selectedIndex = -1;
            nodes[3].selectedIndex = -1;
        }

        function onImport() {
            var tpl_efan_list = doT.template(document.getElementById('tpl_efan_import').innerHTML);
            var dlg = new cbDlg();
            dlg.title = "导入 风电机";
            dlg.css = "width:610px";
            dlg.Add(tpl_efan_list());
            dlg.Show();
        }

        function EditEfan(t) {
            var efan = GetSub(g_efans.data, "id", $(t).attr("id"));
            var form = new EfanForm();
            var dlg = new cbDlg();
            dlg.title = "编辑 风电机";
            dlg.css = "width:610px";
            dlg.Add(form.Render(efan));
            dlg.Show();
        }

        function uploadFile() {
            var file = $("#upload_efan").get(0).files[0];
            var formData = new FormData();
            formData.append("file", file);
            var req = new XMLHttpRequest();
            req.upload.onprogress = function (evt) {
                var loaded = evt.loaded;     //已经上传大小情况   
                var tot = evt.total;      //附件总大小   
                var per = Math.floor(100 * loaded / tot);  //已经上传的百分比   
                $("#progress").html(per + "%");
                $("#progress").css("width", per + "%");
            };
            req.onreadystatechange = function () {
                if (req.readyState == 4 && req.status == 200) {
                    alert(req.responseText);
                }
            };
            req.open("POST", "/upload", true);
            req.send(formData);
        }

        function FieldToShow(data, field) {
            if (field== "efanvender_id") return GetSub(g_efanvenders.data, "id", data[field]).name;
            else if (field == "leafvender_id") return GetSub(g_leafvenders.data, "id", data[field]).name;
            else return data[field];
        }
        function FieldToEdit(data, field) {
            if (field == "efanvender_id") return RenderSelect(g_efanvenders.data, data[field]);
            else if (field == "leafvender_id") return RenderSelect(g_leafvenders.data, data[field]);
            else return data[field];
        }

    </script>
</body>
</html>