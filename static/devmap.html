<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
    <script type="text/javascript" src="http://api.map.baidu.com/api?v=3.0&ak=nSxiPohfziUaCuONe4ViUP2N"></script>
    <script src="js/jquery.js"></script>
    <script src="js/bootstrap.js"></script>
    <link rel="stylesheet" href="css/bootstrap.css" />
    <script type="text/javascript" src="js/doTe.js"></script>
    <script src="laydate/laydate.js"></script>
    <script src="js/utils.js"></script>
    <script src="js/db.js"></script>
    <link rel="stylesheet" href="css/xpecker.css" />
    <script src="js/xpecker.js"></script>
    <script src="js/Cube.js"></script>
    <script src="js/xmap.js"></script>
  
</head>
<body onbeforeunload="UpdateCurData()">
    <div id="allmap" style="height: 100%;width: 100%;"></div>
</body>
</html>
<script type="text/javascript">
    var g_map = CreateMap("allmap"), g_devwhs, g_devs, g_user = parent.g_user, g_editmode = false;;
    if (g_user == undefined)
        g_user = GetRoleUser("设备超级帐号");

    // 在地图上显示驻地
    var param_devwh = g_user.job == "4" ? "" : "&id=" + g_user.depart_id;
    Reqdata("/rd?ls=devwh" + param_devwh, "", function (res1) {
        g_devwh = res1;
        for (var x in res1.data)
            CreateMark("devwh", res1.data[x], res1.ls, res1.fields);
        if (res1.data.length > 0 )
            g_map.centerAndZoom(CreatePoint(res1.data[0].position), 11);
    });

    // 在地图上显示设备
    var param_dev = g_user.job == "4" ? "" : "&devwh_id=" + g_user.depart_id;
    Reqdata("/rd?ls=dev" + param_dev, "", function (res2) {
        g_devs = res2;
        for (var x in res2.data)
            CreateMark(GetSub(db_devclss, "id",res2.data[x].clss).name, res2.data[x], res2.ls, res2.fields);
    });

    // 编辑浏览模式控件
    g_map.addControl(new ModeControl(function (mode) {
        if (mode) {
            for (var i in g_devwh.data) g_devwh.data[i].mk.enableDragging();
            for (var i in g_devs.data) g_devs.data[i].mk.enableDragging();
        }
        else {
            for (var i in g_devwh.data) g_devwh.data[i].mk.disableDragging();
            for (var i in g_devs.data) g_devs.data[i].mk.disableDragging();
        }
    }));
</script>
