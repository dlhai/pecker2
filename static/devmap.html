<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
    <script type="text/javascript" src="http://api.map.baidu.com/api?v=3.0&ak=nSxiPohfziUaCuONe4ViUP2N"></script>
    <script src="js/jquery.js"></script>
    <script src="js/bootstrap.js"></script>
    <link rel="stylesheet" href="css/bootstrap.css" />
    <script type="text/javascript" src="js/doTe.js"></script>
    <script src="laydate/laydate.js"></script>
    <script src="js/utils.js"></script>
    <script src="js/db.js"></script>
    <link rel="stylesheet" href="css/xpecker.css" />
    <script src="js/xpecker.js"></script>
    <script src="js/Cube.js"></script>

    <style>
        /*为了解决BootStrap中css和layDate的css样式冲突*/
        .laydate_box, .laydate_box * {
            box-sizing: content-box;
        }
        .laydate_box th {
            text-align: center;
        }
    </style>
    <script id="tpl_efan_edit2" type="text/template">
        <div class="xEFanForm">
            <form id="form_efan">
                <strong>编号:</strong><input name="code" value="{%=it.code%}" />
                <strong>型号:</strong><input name="type" value="{%=it.type%}" />
                <strong>生产厂家:</strong><select class="efanvender_id" data-id="{%=it.efanvender_id%}" name="efanvender_id" style="margin-right:0px;"></select>
            </form>
            <form id="form_leaf0"></form><form id="form_leaf1"></form><form id="form_leaf3"></form>
            <table>
                <thead><tr><th>编号</th><th>主要材料</th><th>出厂时间</th><th>挂机时间</th><th style="width:90px">生产厂家</th></tr></thead>
                <tbody>
                    {% for (var i = 0; i < it.leafs.length; i++) { %}
                    <tr>
                        <td><input form="form_leaf{%=it.leafs[i]%}" name="code" value="{%=it.leafs[i].code%}" /></td>
                        <td><input form="form_leaf{%=it.leafs[i]%}" name="mat" value="{%=it.leafs[i].mat%}" /></td>
                        <td><input form="form_leaf{%=it.leafs[i]%}" name="producedate" value="{%=it.leafs[i].producedate%}" onClick="laydate()" /></td>
                        <td><input form="form_leaf{%=it.leafs[i]%}" name="putondate" value="{%=it.leafs[i].putondate%}" onClick="laydate()" /></td>
                        <td><select form="form_leaf{%=it.leafs[i]%}" class="leafvender_id" name="leafvender_id" data-id="{%=it.leafs[i].leafvender_id%}"></select></td>
                    </tr>
                    {% } %}
                </tbody>
            </table>
        </div>
    </script>
</head>
<body onbeforeunload="UpdateCurData()">
    <div id="allmap" style="height: 100%;width: 100%;"></div>
</body>
</html>
<script type="text/javascript">
    // 百度地图API功能
    var map = new BMap.Map("allmap");
    map.centerAndZoom(new BMap.Point(116.404, 39.915), 6); //设置中心点坐标和地图级别
    map.addControl(new BMap.ScaleControl({ anchor: BMAP_ANCHOR_BOTTOM_RIGHT })); // 左下角，添加比例尺
    map.addControl(new BMap.NavigationControl({ anchor: BMAP_ANCHOR_TOP_RIGHT })); //左上角，添加默认缩放平移控件
    map.enableScrollWheelZoom();//开启鼠标滚轮缩放

    g_user = parent.g_user;
    g_user = {"id": "327","account": "xupucun","name": "徐濮存","face": "img/face/face3.jpg","depart_id": "0","depart_table": "0","job": "4"}

    var editmode = false;
    var g_devwhs, g_devs;

    // 在地图上显示驻地
    Reqdata("/rd?ls=devwh", "", function (res1) {
        g_devwh = res1;
        for (var x in res1.data)
            CreateMark("devwh", res1.data[x], res1.ls, res1.fields);
        if (res1.data.length > 0 )
            map.centerAndZoom(CreatePoint(res1.data[0].position), 14); //设置中心点坐标和地图级别
    });

    // 在地图上显示设备
    Reqdata("/rd?ls=dev", "", function (res2) {
        g_devs = res2;
        for (var x in res2.data)
            CreateMark(GetSub(db_devclss, "id",res2.data[x].clss).name, res2.data[x], res2.ls, res2.fields);
    });

    // 创建控件
    var modectrl = new ModeControl();
    // 添加到地图当中
    map.addControl(modectrl);


    function CreateMark(iconname, data, type, fields) {
        var marker = new BMap.Marker(CreatePoint(data.position), { icon: GetIcon(iconname) });
        var label = new BMap.Label("name" in data ? data.name : data.code, { offset: new BMap.Size(-10, 32) });
        label.setStyle({ border: "0px", color: "blue" });
        marker.setLabel(label);
        map.addOverlay(marker);
        data.mk = marker;
        marker.addEventListener("dragend", function (type, target, pixel, point) { UpdateCurData(type, data); });
        marker.addEventListener("click", function (e) { ShowWindow(data, fields, e); });
        label.addEventListener("click", function (e) { ShowWindow(data, fields, e); });
    }

    function GetIcon(iconname) {
        icons = new Object();
        if (!(iconname in icons)) {
            var name = "/static/img/" + iconname + ".png";
            icons[iconname] = new BMap.Icon(name, new BMap.Size(32, 32));
            icons[iconname].imageSize = new BMap.Size(32, 32);
        }
        return icons[iconname];
    }

    //-----------------ModeControl begin------------------------------------------------
    // 定义模式控件,即function
    function ModeControl() {
        // 默认停靠位置和偏移量
        this.defaultAnchor = BMAP_ANCHOR_TOP_LEFT;
        this.defaultOffset = new BMap.Size(10, 10);
    }
    // 通过JavaScript的prototype属性继承于BMap.Control
    ModeControl.prototype = new BMap.Control();
    // 自定义控件必须实现自己的initialize方法,并且将控件的DOM元素返回
    // 在本方法中创建个div元素作为控件的容器,并将其添加到地图容器中
    ModeControl.prototype.initialize = function (map) {
        // 创建一个DOM元素
        var div = document.createElement("div");
        div.innerHTML = '浏览';
        div.style.backgroundColor = "white";
        div.style.border = "1px solid lavender";
        div.style.boxShadow = "1px 1px 1px rgba(0,0,0,.1)";
        div.style.padding = "5px 10px";
        $(div).addClass( "xRndAngle" );
        $(div).on("click", function () {
            editmode = !editmode;
            if (editmode) {
                div.innerHTML = '编辑';
                for (var i in winders.data)
                    winders.data[i].mk.enableDragging();
                for (var i in efans.data)
                    efans.data[i].mk.enableDragging();
            }
            else {
                div.innerHTML = '浏览';
                for (var i in winders.data)
                    winders.data[i].mk.disableDragging();
                for (var i in efans.data)
                    efans.data[i].mk.disableDragging();
            }
        });

        // 添加DOM元素到地图中
        map.getContainer().appendChild(div);
        // 将DOM元素返回
        return div;
    }
    // -----------------ModeControl end---------------------------

    function CreatePoint( pos ) {
        var ar = pos.split(" ");
        return new BMap.Point(parseFloat(ar[0]), parseFloat(ar[1]));
    }

    function CreatePolygon( pos ) {
        var ar = pos.split(",");
        var arr = [];
        for (var i in ar)
            arr.push(CreatePoint(ar[i]));
        return new BMap.Polygon(arr, { strokeColor: "Chocolate", strokeWeight: 2, strokeOpacity: 0.5 });
    }

    function ShowWindow(data,fields,e) {
        var p = e.target;
        var point = new BMap.Point(p.getPosition().lng, p.getPosition().lat);
        var content = '<div class="xRndAngle x2Form" style="overflow-y: scroll;height:290px;padding:5px 0px">' + RenderPane2(data, fields) + '</div>';
        var infoWindow = new BMap.InfoWindow(content, {
            width: 619,     // 信息窗口宽度
            height: 320,     // 信息窗口高度
            title: "风场信息", // 信息窗口标题
            enableMessage: true//设置允许信息窗发送短息
        });  // 创建信息窗口对象 
        map.openInfoWindow(infoWindow, point); //开启信息窗口
        ID2Name(ar, i);
    }

</script>
