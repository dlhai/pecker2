<!DOCTYPE html>
<html>
<head>
    <!--user2与user3的区别：将inplace编辑模式改成弹出6编辑窗口式-->
    <meta charset="utf-8">
    <title>啄木鸟风电维保系统</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <link rel="stylesheet" href="css/bootstrap.css" />
    <script type="text/javascript" src="js/doTe.js"></script>
    <script src="js/jquery.js"></script>
    <script src="js/bootstrap.js"></script>
    <script src="laydate/laydate.js"></script>
    <script src="js/utils.js"></script>
    <link rel="stylesheet" href="css/cube.css" />
    <script src="js/Cube.js"></script>
    <script src="js/db.js"></script>
    <link rel="stylesheet" href="css/xpecker.css" />
    <script src="js/xpecker.js"></script>
    <script src="js/user.js"></script>
    <style>
        .narrow>div>div:first-of-type {width: 140px;}
        .narrow>div>label:first-of-type {width: 40px;}
        .narrow>div,.narrow>div>div:first-of-type {margin-right: 0px;}
        .live {
            background: #808080;
            border: 0px;
        }
        .title {
            display: inline-block;
            border-radius: 4px;
            padding: 4px 15px;
            border: 1px solid #dddddd;
        }
    </style>
</head>
<body class="xFCsrow" >
    <section class="xPanel2" style="width:100px"><!--两个子项都固定宽度100，使它们获得相同的增量-->
        <header class="heading">列表<div style="float: right;"><a onClick="onclickfun('useradd')">添加</a></div></header>
        <div id="userlist" class="xScroll" style="padding:5px;height:100px;flex-grow: 1;">
        </div>
    </section>

    <section class="xPanel2" style="width:100px;">
        <header class="heading" style="padding:5px;"><div class="title live" onClick="onclickpane(this)">信息</div> <div class="title" onClick="onclickpane(this)">动态</div></header>
        <div id="pane" style="padding:5px 0px 5px 0px;"></div>
    </section>

    <script type="text/javascript">
        var g_focus, g_users, g_ethnic, g_departs, g_user = parent.g_user, g_pane ="信息";
        Reqdata("/curuserinf", "", function (res) {
            g_user = res.data;

            Reqdata("/rd?ls=config&type=ethnic", "", function (res) { g_ethnic = res.data; });
            if (isInArray(["1", "4", "7"], g_user.job))
                Reqdata("/rd?ls=" + { "1": "winder", "4": "devwh", "7": "matwh" }[g_user.job], "", function (res) { g_departs = res; });
            Reqdata(GetUrl(), "", function (res) {
                g_users = res;
                var fielddepart = GetSub(g_users.fields, "name", "depart_id");
                if (!isInArray(["1", "4", "7"], g_user.job)) { // 除此三类超级用户外不显示所在单位(风场、仓库、驻地)
                    var idx = GetIdx(g_users.fields, "name", "depart_id");
                    fielddepart.twidth = 0;
                    fielddepart.ftype = "none";
                    if (g_user.job == 13) {// 专家超级帐号
                        var idx = GetIdx(g_users.fields, "name", "skill");
                        g_users.fields[idx].twidth = "100px";
                        g_users.fields[idx].ftype = "multiselect";
                    }
                }
                else {
                    var idx = GetIdx(g_users.fields, "name", "depart_id");
                    fielddepart.twidth = "100px";
                    fielddepart.ftype = "select";
                }

                $("#userlist").html(RenderTable2(g_users, undefined, ValToView));
                onclickpane($(".live")[0]);
            });
        });
        function GetUrl() {
            var param = (g_user.depart_id == "0") ? "" : ("&depart_id=" + g_user.depart_id);
            var url = "/rduser?job=" + GetsubJob(g_user.job, "string") + param
            if (g_user.job == "16") // 维修队长
                url = "/rdteam?user_id=" + g_user.id;

            return url;
        }

        //点击表格行
        $("html").on("click", function () {
            var td = $(event.target);
            if (td[0].localName == "td" && td.parents(".xTable").length > 0) {
                var tr = td.parent();
                g_focus = GetSub(g_users.data, "id", tr.attr("data_id"));
                showdetail(g_focus);
            }
        });

        function onclickpane(This) {
            $(This).siblings().removeClass("live");
            $(This).addClass("live");
            if ($(This).html() == "信息"){
                var tpl = `<section class="xPanel2">
                        <header class="heading">{name}<div style="float: right;">
                            <a onClick="onclickfun('{code}add')">添加</a>
                            <a onClick="onclickfun('{code}edit')">编辑</a></div>
                        </header>
                        <div id="{code}" style="padding:5px 0px 5px 0px;"></div>
                    </section>`;

                var modules = [{ code: "user", name: "基本信息" }, { code: "certif", name: "证件信息" },
                    { code: "edu", name: "受教育经历" }, { code: "employ", name: "就业经历" }];
                $("#pane").html(modules.map(x => tpl.format(x)).join(""));
            }
            else {
                var tpl = `<section class="xPanel2">
                    <header class="heading">{name}</header>
                    <div id="{code}" class="x2Form" style="padding:5px 0px 5px 0px;"></div>
                </section>`;
                var modules = [{ code: "article", name: "文章" }, { code: "discuss", name: "评论" }];
                $("#pane").html(modules.map(x => tpl.format(x)).join(""));
            }
        }

        function onclickfun(fun) {
            if (fun == "useradd") {
                var tpl =
                    `<div class="x2Form" style="padding: 0px 0px 0px 30px;">
                        <div style="float: left; margin:0px;"><img style="width: 100px;height: 180px;" src="img/bird.jpg" /></div>
                        <div><label>帐号</label><input id="username" /></div>
                        <div><label>密码</label><input id="pwd1" type="password"/></div>
                        <div><label>密码</label><input id="pwd2" type="password"/></div>
                    </div>`;

                var dlg = new cbDlg("新建 用户", "", tpl);
                dlg.submit = function () {
                    var newuser = Create(g_users.fields);
                    newuser.account = $("#username").val();
                    newuser.pwd = $("#pwd1").val();
                    var pwd2 = $("#pwd2").val();
                    if (newuser.account == ""){alert("帐号不能为空");return;}
                    if (newuser.pwd != pwd2) {alert("两次输入的密码不一致");return;}
                    if (newuser.pwd == "") {alert("密码不能为空");return;}

                    var val = `{"ls":"user","val":{"account":"{account}","pwd":"{pwd}"}}`.format({
                        "account": newuser.account, "pwd": newuser.pwd });
                    ReqdataP('/cr', val, "", function (res) {
                        if (res.result != 200){alert("新建失败！");return;}
                        newuser.id = res.id;
                        dlg.closedlg();
                    });

                    newuser.depart_id = g_user.depart_id;
                    newuser.depart_table = g_user.depart_table;
                    var dlg2 = new cbDlg("新建 用户", "width:900px");
                    dlg2.Add(xruserlive(newuser, g_users.fields));
                    dlg2.Show();
                    dlg2.submit = onusersave(newuser);
                }
                dlg.Show();

            }
            else if (fun == "useredit") {
                var dlg = new cbDlg("编辑 用户", "width:900px");
                dlg.Add(xruserlive(g_focus, g_users.fields));
                dlg.Show();
            }
            else if (fun == "certifadd") {

            }
            else if (fun == "certifedit") {

            }
            else if (fun == "eduadd") {

            }
            else if (fun == "eduedit") {

            }
            else if (fun == "employadd") {

            }
            else if (fun == "employedit") {

            }
        }

        function showdetail(user) {
            if (g_pane == "信息") {
                $("#user").html(xrusershow(user, g_users.fields));
                Reqdata("/rd?ls=certif&user_id=" + user.id, "", function (res) { $("#certif").html(xrcertifshow(res.data)); });
                Reqdata("/rd?ls=edu&user_id=" + user.id, "", function (res) { $("#edu").html(xredushow(res.data)); });
                Reqdata("/rd?ls=employ&user_id=" + user.id, "", function (res) { $("#employ").html(xremployshow(res.data)); });
            }
            else {

            }
        }

        function ValToView(user, field) {
            var name = field.name ? field.name : field;
            if (name == "sex") return GetSub(db_sex, "id", user.sex).name;
            else if (name == "job") return GetSub(db_job, "id", user.job).name;
            else if (name == "depart_id") return GetSub(g_departs.data, "id", user.depart_id).name;
            else return user[name];
        }
    </script>
</body>
</html>
