<!DOCTYPE html>
<html>
<head>
    <!--user2与user3的区别：将inplace编辑模式改成弹出6编辑窗口式-->
    <meta charset="utf-8">
    <title>啄木鸟风电维保系统</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <link rel="stylesheet" href="css/bootstrap.css" />
    <script type="text/javascript" src="js/doTe.js"></script>
    <script src="js/jquery.js"></script>
    <script src="js/bootstrap.js"></script>
    <script src="laydate/laydate.js"></script>
    <script src="js/utils.js"></script>
    <link rel="stylesheet" href="css/cube.css" />
    <script src="js/Cube.js"></script>
    <script src="js/db.js"></script>
    <link rel="stylesheet" href="css/xpecker.css" />
    <script src="js/xpecker.js"></script>
    <script src="js/user.js"></script>
    <style>
        .live{background:#808080;}
    </style>
</head>
<body class="xFCsrow" >
    <section class="xPanel2" style="width:100px"><!--两个子项都固定宽度100，使它们获得相同的增量-->
        <header class="heading">列表<div style="float: right;"><a onClick="onAddUser()">添加</a></div></header>
        <div id="userlist" class="xScroll" style="padding:5px;height:100px;flex-grow: 1;">
        </div>
    </section>

    <div class="xPanel2 xScroll" style="width:100px;border:0px;">
        <header class="heading"><div class="live" onClick="onclickpane(this)">信息</div> <div onClick="onclickpane(this)">动态</div></header>
        <div id="pane" style="padding:5px 0px 5px 0px;">
            <section class="xPanel2">
                <header class="heading">基本信息<div style="float: right;"><a onClick="onclick('useradd')">添加</a> <a onClick="onclick('useredit')">编辑</a></div></header>
                <div id="d_baseinf" class="x2Form" style="padding:5px 0px 5px 0px;"></div>
            </section>
            <section id="d_certiflist" class="xPanel2">
                <header class="heading">证件信息<div style="float: right;"><a onClick="onclick('certifadd')">添加</a> <a onClick="onclick('certifedit')">编辑</a></div></header>
                <div id="d_baseinf" class="x2Form" style="padding:5px 0px 5px 0px;"></div>
            </section>
            <section id="d_edulist" class="xPanel2">
                <header class="heading">受教育经历<div style="float: right;"><a onClick="onclick('eduadd')">添加</a> <a onClick="onclick('eduedit')">编辑</a></div></header>
                <div id="d_baseinf" class="x2Form" style="padding:5px 0px 5px 0px;"></div>
            </section>
            <section id="d_employlist" class="xPanel2">
                <header class="heading">就业经历<div style="float: right;"><a onClick="onclick('employadd')">添加</a> <a onClick="onclick('employedit')">编辑</a></div></header>
                <div id="d_baseinf" class="x2Form" style="padding:5px 0px 5px 0px;"></div>
            </section>
        </div>
    </div>

    <script type="text/javascript">
        var g_curuser, g_users, g_ethnic, g_departs, g_user = parent.g_user, g_pane;
        Reqdata("/curuserinf", "", function (res) {
            g_user = res.data;

            Reqdata("/rd?ls=config&type=ethnic", "", function (res) { g_ethnic = res.data; });
            if (isInArray(["1", "4", "7"], g_user.job))
                Reqdata("/rd?ls=" + { "1": "winder", "4": "devwh", "7": "matwh" }[g_user.job], "", function (res) { g_departs = res; });
            Reqdata(GetUrl(), "", function (res) {
                g_users = res;
                if (!isInArray(["1", "4", "7"], g_user.job)) { // 除此三类超级用户外不显示所在单位(风场、仓库、驻地)
                    var idx = GetIdx(g_users.fields, "name", "depart_id");
                    g_users.fields[idx].twidth = 0;
                    g_users.fields[idx].ftype = "none";
                    if (g_user.job == 13) {// 专家超级帐号
                        var idx = GetIdx(g_users.fields, "name", "skill");
                        g_users.fields[idx].twidth = "100px";
                        g_users.fields[idx].ftype = "select";
                    }
                }
                else {
                    var idx = GetIdx(g_users.fields, "name", "depart_id");
                    g_users.fields[idx].twidth = "100px";
                    g_users.fields[idx].ftype = "multiselect";
                }

                $("#userlist").html(RenderTable2(g_users, undefined, ValToView));
            });
        });
        function GetUrl() {
            var param = (g_user.depart_id == "0") ? "" : ("&depart_id=" + g_user.depart_id);
            var url = "/rduser?job=" + GetsubJob(g_user.job, "string") + param
            if (g_user.job == "16") // 维修队长
                url = "/rdteam?user_id=" + g_user.id;

            return url;
        }

        //点击表格行
        $("html").on("click", function () {
            var td = $(event.target);
            if (td[0].localName == "td" && td.parents(".xTable").length > 0) {
                var tr = td.parent();
                showdetail(tr.attr("data_id"));
            }
        });

        function onclickpane(This) {
            if ($(This).html() == "信息"){
                var tpl = `<section class="xPanel2">
                    <header class="heading">{name}<div style="float: right;"><a onClick="onclick('{code}add')">添加</a> <a onClick="onclick('{code}edit')">编辑</a></div></header>
                    <div id="{code}" class="x2Form" style="padding:5px 0px 5px 0px;"></div>
                </section>`;

                var modules = [{ code: "user", name: "基本信息" }, { code: "certif", name: "证件信息" },
                    { code: "edu", name: "受教育经历" }, { code: "employ", name: "就业经历" }];
                $("#pane").html(modules.map(x => tpl.format(x)).join("")));
            }
            else {
                var tpl = `<section class="xPanel2">
                    <header class="heading">{name}</header>
                    <div id="{code}" class="x2Form" style="padding:5px 0px 5px 0px;"></div>
                </section>`;
                var modules = [{ code: "article", name: "文章" }, { code: "discuss", name: "评论" }];
                $("#pane").html(modules.map(x => tpl.format(x)).join("")));
            }
        }

        function showdetail(userid) {
            var user = GetSub(g_users.data, "id", userid);
            if (g_pane == "信息") {
                $("#user").html(xrusershow(user, g_users.fields));
                Reqdata("rd?ls=certif&user_id=" + user.id, "", function (res) { $("#certif").html(xrcertifshow(res.data)); });
                Reqdata("rd?ls=edu&user_id=" + user.id, "", function (res) { $("#edu").html(xredushow(res.data)); });
                Reqdata("rd?ls=employ&user_id=" + user.id, "", function (res) { $("#employ").html(xremployshow(res.data)); });
            }
            else {

            }
        }

        function xrusershow(user, fields) {
            var ui2 = `
                <div style="float:left;display:block;height:240px;width:280px;margin-top:5px;">
                    <div style="float:left;display:block;height:78px;width:78px;">
                        <img style="width:100%;height:100%;" {face}>
                    </div>
                    <div class="x2Form narrow">
                        <div style="margin-top:0px;"><label>帐号</label><div style="display:inline-block;">{account}</div></div>
                        <div><label>密码</label><div></div>
                    </div>
                    <div style="width:280px;height:160px;margin-top:5px">
                        <img style="width:100%;height:100%;" {idimg} >
                    </div>
                </div>`;

            return ui2.format({
                "account": user.account, face: (user.face == "" ? "" : 'src="' + user.face + '"'),
                idimg: (user.idimg == "" ? "" : 'src="' + user.idimg + '"')
            }) + RenderPane2(g_user, fields, function(user, field) {
                var name = field.name ? field.name : field;
                if (name == "sex") return GetSub(db_sex, "id", user.sex).name;
                else if (name == "job") return GetSub(db_job, "id", user.job).name;
                else if (name == "depart_id") return GetSub(g_departs.data, "id", user.depart_id).name;
                else return user[name];
            });
        }

        function onAddUser() {
            var tpl_user_new = doT.template(document.getElementById('tpl_user_new').innerHTML);
            var dlg = new cbDlg();
            dlg.title = "新建 用户";
            var newuser = Create(g_users.fields);
            dlg.Add(tpl_user_new(newuser));
            dlg.submit = function () {
                newuser.account = $("#username").val();
                newuser.depart_name = g_user.depart_name;
                var form = new Userform();
                var dlg2 = new cbDlg();
                dlg2.Add(form.render(newuser, g_fields));
                dlg2.css = "width:900px;";
                dlg2.Show();
                $(".drop").on("click", function () { $(this).siblings("div.dropwnd").css("display", "block"); });
                $("#job").on("click", function () { TreeAddChildren($("#job>div").attr("id")); });
                $(".xTree div>img").unbind("click", TreeItemExpand);
                $(".xTree div>span").unbind("click", TreeItemClick);
                $(".xTree div>img").bind("click", TreeItemExpand);
                $(".xTree div>span").bind("click", TreeItemClick);
                rebindevent();
            }
            dlg.Show();
        }

        function onEditUser() {
            var form = new Userform();
            $("#ModalDlgContent").html(form.render(g_cur, g_fields));
            $(".drop").on("click", function () { $(this).siblings("div.dropwnd").css("display", "block"); });
            $("#job").on("click", function () { TreeAddChildren($("#job>div").attr("id")); });

            $(".xTree div>img").unbind("click", TreeItemExpand);
            $(".xTree div>span").unbind("click", TreeItemClick);
            $(".xTree div>img").bind("click", TreeItemExpand);
            $(".xTree div>span").bind("click", TreeItemClick);

            $("#ModalDlgTitle").html("编辑 用户");
            $('#ModalDlg').modal('show');
            rebindevent();
        }

    </script>
</body>
</html>
